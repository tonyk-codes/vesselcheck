<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È¶ôÊ∏ØËàπÈöªÊü•Ë©¢Á≥ªÁµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --secondary: #2d3748;
            --accent: #3182ce;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --bg-light: #f7fafc;
            --border: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Microsoft JhengHei", "Segoe UI", sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 28px;
        }
        
        .logo h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .logo p {
            font-size: 12px;
            opacity: 0.85;
            margin-top: 2px;
        }
        
        .header-info {
            text-align: right;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Main Content */
        main {
            padding: 24px 0;
        }
        
        /* Search Card */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: var(--bg-light);
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Search Mode Tabs */
        .search-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 12px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .tab-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Search Form */
        .search-form {
            display: none;
        }
        
        .search-form.active {
            display: block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px 12px;
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .form-group input::placeholder {
            color: var(--text-muted);
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .btn {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2b6cb0;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #1a202c;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-item .label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading p {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .loading .progress-info {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message.error {
            background: #fed7d7;
            color: #c53030;
            border-left: 3px solid var(--danger);
        }
        
        .message.info {
            background: #bee3f8;
            color: #2b6cb0;
            border-left: 3px solid var(--accent);
        }
        
        .message.success {
            background: #c6f6d5;
            color: #276749;
            border-left: 3px solid var(--success);
        }
        
        /* Table */
        .table-wrapper {
            overflow-x: auto;
            display: none;
        }
        
        .table-wrapper.show {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        thead {
            background: var(--bg-light);
        }
        
        th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        tbody tr:hover {
            background: #f8fafc;
        }
        
        .highlight {
            background: #fefcbf !important;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .badge-arrival {
            background: #c6f6d5;
            color: #276749;
        }
        
        .badge-departure {
            background: #fed7d7;
            color: #c53030;
        }
        
        /* No Results */
        .no-results {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .no-results.show {
            display: block;
        }
        
        .no-results h3 {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .no-results p {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Footer */
        footer {
            background: var(--secondary);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        footer .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        
        footer a {
            color: #90cdf4;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Debug Panel */
        .debug-panel {
            background: #1a202c;
            color: #68d391;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-panel pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header .container {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .header-info {
                text-align: center;
            }
            
            .search-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            footer .container {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <span class="logo-icon">‚öì</span>
                <div>
                    <h1>È¶ôÊ∏ØËàπÈöªÊü•Ë©¢Á≥ªÁµ±</h1>
                    <p>È¶ôÊ∏ØÊµ∑‰∫ãËôïËàπÈöªÈÄ≤Âá∫Ê∏ØË≥áÊñôÊü•Ë©¢</p>
                </div>
            </div>
            <div class="header-info">
                <p>Ë≥áÊñô‰æÜÊ∫êÔºöÈ¶ôÊ∏ØÊîøÂ∫úË≥áÊñô‰∏ÄÁ∑öÈÄö</p>
                <p>data.gov.hk</p>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <!-- Search Card -->
            <div class="card">
                <div class="card-header">
                    <span>üîç</span>
                    <h2>Êü•Ë©¢ÈÅ∏È†Ö</h2>
                </div>
                <div class="card-body">
                    <!-- Search Mode Tabs -->
                    <div class="search-tabs">
                        <button class="tab-btn active" data-mode="realtime" onclick="switchMode('realtime')">
                            Âç≥ÊôÇÊü•Ë©¢ÔºàÈÅéÂéª36Â∞èÊôÇÔºâ
                        </button>
                        <button class="tab-btn" data-mode="historical" onclick="switchMode('historical')">
                            Ê≠∑Âè≤Ë≥áÊñôÊü•Ë©¢
                        </button>
                        <button class="tab-btn" data-mode="bydate" onclick="switchMode('bydate')">
                            ÊåâÊó•ÊúüÂàóÂá∫ÊâÄÊúâËàπÈöª
                        </button>
                    </div>
                    
                    <!-- Mode 1: Real-time (Last 36 hours) -->
                    <div class="search-form active" id="form-realtime">
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                            Êü•Ë©¢ÈÅéÂéª36Â∞èÊôÇÂÖßÊäµÊ∏ØÊàñÈõ¢Ê∏ØÁöÑËàπÈöªË≥áÊñô„ÄÇËº∏ÂÖ•ËàπÈöªÂêçÁ®±ÂèØÈ°ØÁ§∫ÂÖ∂ÊäµÊ∏Ø/Èõ¢Ê∏ØÊôÇÈñì„ÄÇ
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vesselNameRealtime">ËàπÈöªÂêçÁ®±ÔºàÂèØÈÅ∏Ôºâ</label>
                                <input type="text" id="vesselNameRealtime" placeholder="Ëº∏ÂÖ•ËàπÈöªÂêçÁ®±...">
                            </div>
                            <div class="form-group">
                                <label for="dataTypeRealtime">Ë≥áÊñôÈ°ûÂûã</label>
                                <select id="dataTypeRealtime">
                                    <option value="both">ÊäµÊ∏ØÂèäÈõ¢Ê∏Ø</option>
                                    <option value="arrival">ÂÉÖÊäµÊ∏Ø</option>
                                    <option value="departure">ÂÉÖÈõ¢Ê∏Ø</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode 2: Historical by Vessel Name -->
                    <div class="search-form" id="form-historical">
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                            Ëº∏ÂÖ•ËàπÈöªÂêçÁ®±ÂèäÊôÇÈñìÁØÑÂúçÔºåÊü•Ë©¢Ë©≤ËàπÈöªÁöÑÊ≠∑Âè≤ÈÄ≤Âá∫Ê∏ØË®òÈåÑ„ÄÇ
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vesselNameHistorical">ËàπÈöªÂêçÁ®± *</label>
                                <input type="text" id="vesselNameHistorical" placeholder="Ëº∏ÂÖ•ËàπÈöªÂêçÁ®±..." required>
                            </div>
                            <div class="form-group">
                                <label for="startDateHistorical">ÈñãÂßãÊó•Êúü</label>
                                <input type="date" id="startDateHistorical">
                            </div>
                            <div class="form-group">
                                <label for="endDateHistorical">ÁµêÊùüÊó•Êúü</label>
                                <input type="date" id="endDateHistorical">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode 3: List all vessels by date -->
                    <div class="search-form" id="form-bydate">
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                            ÈÅ∏ÊìáÊó•ÊúüÂèäÊôÇÈñìÔºåÂàóÂá∫Ë©≤ÊôÇÊÆµÊâÄÊúâÈÄ≤Âá∫Ê∏ØËàπÈöª„ÄÇ
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dateBydate">Êó•Êúü *</label>
                                <input type="date" id="dateBydate" required>
                            </div>
                            <div class="form-group">
                                <label for="timeBydate">ÊôÇÈñì</label>
                                <select id="timeBydate">
                                    <option value="0000">00:00</option>
                                    <option value="0100">01:00</option>
                                    <option value="0200">02:00</option>
                                    <option value="0300">03:00</option>
                                    <option value="0400">04:00</option>
                                    <option value="0500">05:00</option>
                                    <option value="0600">06:00</option>
                                    <option value="0700">07:00</option>
                                    <option value="0800">08:00</option>
                                    <option value="0900">09:00</option>
                                    <option value="1000">10:00</option>
                                    <option value="1100">11:00</option>
                                    <option value="1200">12:00</option>
                                    <option value="1300">13:00</option>
                                    <option value="1400">14:00</option>
                                    <option value="1500">15:00</option>
                                    <option value="1600">16:00</option>
                                    <option value="1700">17:00</option>
                                    <option value="1800">18:00</option>
                                    <option value="1900">19:00</option>
                                    <option value="2000">20:00</option>
                                    <option value="2100">21:00</option>
                                    <option value="2200">22:00</option>
                                    <option value="2300">23:00</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dataTypeBydate">Ë≥áÊñôÈ°ûÂûã</label>
                                <select id="dataTypeBydate">
                                    <option value="both">ÊäµÊ∏ØÂèäÈõ¢Ê∏Ø</option>
                                    <option value="arrival">ÂÉÖÊäµÊ∏Ø</option>
                                    <option value="departure">ÂÉÖÈõ¢Ê∏Ø</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="performSearch()">
                            <span>üîç</span> ÊêúÂ∞ã
                        </button>
                        <button class="btn btn-secondary" onclick="clearSearch()">
                            Ê∏ÖÈô§
                        </button>
                        <button class="btn btn-success" id="exportBtn" onclick="exportToCSV()" disabled>
                            <span>üì•</span> ÂåØÂá∫ CSV
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Results Card -->
            <div class="card">
                <div class="card-header">
                    <span>üìã</span>
                    <h2>ÊêúÂ∞ãÁµêÊûú</h2>
                </div>
                <div class="card-body">
                    <div class="message error" id="errorMessage"></div>
                    <div class="message info" id="infoMessage"></div>
                    <div class="message success" id="successMessage"></div>
                    
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®Âæû data.gov.hk Áç≤ÂèñË≥áÊñô...</p>
                        <div class="progress-info" id="progressInfo"></div>
                    </div>
                    
                    <div class="stats-row" id="stats" style="display: none;"></div>
                    
                    <div class="no-results" id="noResults">
                        <h3>üì≠ Ê≤íÊúâÊâæÂà∞ÁµêÊûú</h3>
                        <p>Ë´ãÂòóË©¶Ë™øÊï¥ÊêúÂ∞ãÊ¢ù‰ª∂</p>
                    </div>
                    
                    <div class="table-wrapper" id="tableWrapper">
                        <table>
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="debug-panel" id="debugPanel">
                        <pre id="debugContent"></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>¬© 2026 È¶ôÊ∏ØËàπÈöªÊü•Ë©¢Á≥ªÁµ± | Ë≥áÊñô‰æÜÊ∫êÔºö<a href="https://data.gov.hk" target="_blank">ÔøΩÔøΩÊ∏ØÊîøÂ∫úË≥áÊñô‰∏ÄÁ∑öÈÄö</a></p>
            <p>Êú¨Á≥ªÁµ±ÂÉÖ‰æõÂèÉËÄÉÔºåË≥áÊñô‰ª•Êµ∑‰∫ãËôïÂÖ¨‰ΩàÁÇ∫Ê∫ñ</p>
        </div>
    </footer>

    <script>
        // =====================================================
        // CONFIGURATION - Correct API URLs based on data.gov.hk
        // =====================================================
        const CONFIG = {
            // Raw data URLs from Marine Department
            // RP05005i.XML = Vessels arrived in the past 36 hours (Âú®ÈÅéÂéª‰∏âÂçÅÂÖ≠Â∞èÊôÇÊäµÊ∏ØÁöÑËàπÈöª)
            // RP05006i.XML = Vessels departed in the past 36 hours (Âú®ÈÅéÂéª‰∏âÂçÅÂÖ≠Â∞èÊôÇÈõ¢Ê∏ØÁöÑËàπÈöª)
            arrivalRawUrl: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML',
            departureRawUrl: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05006i.XML',
            
            // Historical Archive API
            historicalApiBase: 'https://api.data.gov.hk/v1/historical-archive/get-file',
            
            // CORS proxies (try in order)
            corsProxies: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://cors-anywhere.herokuapp.com/'
            ]
        };
        
        let currentData = [];
        let currentMode = 'realtime';
        let currentProxyIndex = 0;
        
        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDateHistorical').value = yesterday;
            document.getElementById('endDateHistorical').value = today;
            document.getElementById('dateBydate').value = today;
        });
        
        // =====================================================
        // MODE SWITCHING
        // =====================================================
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            document.querySelectorAll('.search-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`form-${mode}`).classList.add('active');
            
            clearResults();
        }
        
        // =====================================================
        // MAIN SEARCH FUNCTION
        // =====================================================
        async function performSearch() {
            clearMessages();
            clearResults();
            
            try {
                switch (currentMode) {
                    case 'realtime':
                        await searchRealtime();
                        break;
                    case 'historical':
                        await searchHistorical();
                        break;
                    case 'bydate':
                        await searchByDate();
                        break;
                }
            } catch (error) {
                console.error('Search error:', error);
                showError(`ÊêúÂ∞ãÊôÇÁôºÁîüÈåØË™§Ôºö${error.message}`);
                hideLoading();
            }
        }
        
        // =====================================================
        // MODE 1: REAL-TIME SEARCH (Last 36 hours)
        // =====================================================
        async function searchRealtime() {
            const vesselName = document.getElementById('vesselNameRealtime').value.trim().toUpperCase();
            const dataType = document.getElementById('dataTypeRealtime').value;
            
            showLoading();
            updateProgress('Ê≠£Âú®Áç≤ÂèñÂç≥ÊôÇËàπÈöªË≥áÊñô...');
            
            let allData = [];
            
            // Fetch arrival data
            if (dataType === 'both' || dataType === 'arrival') {
                updateProgress('Ê≠£Âú®Áç≤ÂèñÊäµÊ∏ØË≥áÊñô...');
                try {
                    const arrivalData = await fetchXMLData(CONFIG.arrivalRawUrl, 'arrival');
                    allData = allData.concat(arrivalData);
                    debugLog(`Fetched ${arrivalData.length} arrival records`);
                } catch (e) {
                    console.warn('Failed to fetch arrival data:', e);
                    debugLog(`Arrival fetch error: ${e.message}`);
                }
            }
            
            // Fetch departure data
            if (dataType === 'both' || dataType === 'departure') {
                updateProgress('Ê≠£Âú®Áç≤ÂèñÈõ¢Ê∏ØË≥áÊñô...');
                try {
                    const departureData = await fetchXMLData(CONFIG.departureRawUrl, 'departure');
                    allData = allData.concat(departureData);
                    debugLog(`Fetched ${departureData.length} departure records`);
                } catch (e) {
                    console.warn('Failed to fetch departure data:', e);
                    debugLog(`Departure fetch error: ${e.message}`);
                }
            }
            
            // Filter by vessel name if provided
            if (vesselName) {
                allData = allData.filter(item => 
                    item.vesselName && item.vesselName.toUpperCase().includes(vesselName)
                );
            }
            
            displayResults(allData, vesselName);
        }
        
        // =====================================================
        // MODE 2: HISTORICAL SEARCH BY VESSEL NAME
        // =====================================================
        async function searchHistorical() {
            const vesselName = document.getElementById('vesselNameHistorical').value.trim().toUpperCase();
            const startDate = document.getElementById('startDateHistorical').value;
            const endDate = document.getElementById('endDateHistorical').value;
            
            if (!vesselName) {
                showError('Ë´ãËº∏ÂÖ•ËàπÈöªÂêçÁ®±');
                return;
            }
            
            if (!startDate || !endDate) {
                showError('Ë´ãÈÅ∏ÊìáÊó•ÊúüÁØÑÂúç');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showError('ÈñãÂßãÊó•ÊúüÂøÖÈ†àÊó©ÊñºÁµêÊùüÊó•Êúü');
                return;
            }
            
            showLoading();
            
            const allData = await fetchHistoricalDataRange(startDate, endDate);
            
            // Filter by vessel name
            const filtered = allData.filter(item => 
                item.vesselName && item.vesselName.toUpperCase().includes(vesselName)
            );
            
            displayResults(filtered, vesselName);
        }
        
        // =====================================================
        // MODE 3: LIST ALL VESSELS BY DATE
        // =====================================================
        async function searchByDate() {
            const date = document.getElementById('dateBydate').value;
            const time = document.getElementById('timeBydate').value;
            const dataType = document.getElementById('dataTypeBydate').value;
            
            if (!date) {
                showError('Ë´ãÈÅ∏ÊìáÊó•Êúü');
                return;
            }
            
            showLoading();
            
            const dateStr = date.replace(/-/g, '');
            const timeParam = `${dateStr}-${time}`;
            
            let allData = [];
            
            // Fetch arrival data
            if (dataType === 'both' || dataType === 'arrival') {
                updateProgress('Ê≠£Âú®Áç≤ÂèñÊäµÊ∏ØÊ≠∑Âè≤Ë≥áÊñô...');
                try {
                    const arrivalData = await fetchHistoricalData(CONFIG.arrivalRawUrl, timeParam, 'arrival');
                    allData = allData.concat(arrivalData);
                } catch (e) {
                    console.warn('Failed to fetch historical arrival data:', e);
                }
            }
            
            // Fetch departure data
            if (dataType === 'both' || dataType === 'departure') {
                updateProgress('Ê≠£Âú®Áç≤ÂèñÈõ¢Ê∏ØÊ≠∑Âè≤Ë≥áÊñô...');
                try {
                    const departureData = await fetchHistoricalData(CONFIG.departureRawUrl, timeParam, 'departure');
                    allData = allData.concat(departureData);
                } catch (e) {
                    console.warn('Failed to fetch historical departure data:', e);
                }
            }
            
            displayResults(allData, '');
        }
        
        // =====================================================
        // FETCH HISTORICAL DATA FOR DATE RANGE
        // =====================================================
        async function fetchHistoricalDataRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let allData = [];
            
            // For each day in range, fetch data at noon (most complete snapshot)
            const current = new Date(start);
            let dayCount = 0;
            const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            while (current <= end) {
                dayCount++;
                const dateStr = current.toISOString().split('T')[0].replace(/-/g, '');
                const timeParam = `${dateStr}-1200`; // Use noon snapshot
                
                updateProgress(`Ê≠£Âú®Áç≤Âèñ ${current.toISOString().split('T')[0]} ÁöÑË≥áÊñô (${dayCount}/${totalDays})...`);
                
                // Fetch arrival data
                try {
                    const arrivalData = await fetchHistoricalData(CONFIG.arrivalRawUrl, timeParam, 'arrival');
                    arrivalData.forEach(item => item.recordDate = current.toISOString().split('T')[0]);
                    allData = allData.concat(arrivalData);
                } catch (e) {
                    console.warn(`Failed to fetch arrival data for ${dateStr}:`, e);
                }
                
                // Fetch departure data
                try {
                    const departureData = await fetchHistoricalData(CONFIG.departureRawUrl, timeParam, 'departure');
                    departureData.forEach(item => item.recordDate = current.toISOString().split('T')[0]);
                    allData = allData.concat(departureData);
                } catch (e) {
                    console.warn(`Failed to fetch departure data for ${dateStr}:`, e);
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            return allData;
        }
        
        // =====================================================
        // FETCH HISTORICAL DATA (SINGLE SNAPSHOT)
        // =====================================================
        async function fetchHistoricalData(rawUrl, timeParam, type) {
            // Build historical API URL
            // Format: https://api.data.gov.hk/v1/historical-archive/get-file?url=<encoded_url>&time=YYYYMMDD-HHMM
            const historicalUrl = `${CONFIG.historicalApiBase}?url=${encodeURIComponent(rawUrl)}&time=${timeParam}`;
            
            debugLog(`Fetching historical: ${historicalUrl}`);
            
            return await fetchXMLData(historicalUrl, type);
        }
        
        // =====================================================
        // FETCH XML DATA (WITH CORS PROXY FALLBACK)
        // =====================================================
        async function fetchXMLData(url, type) {
            let lastError = null;
            
            // Try direct fetch first (for historical API which supports CORS)
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const xmlText = await response.text();
                    debugLog(`Direct fetch successful, response length: ${xmlText.length}`);
                    return parseVesselXML(xmlText, type);
                }
            } catch (e) {
                debugLog(`Direct fetch failed: ${e.message}`);
                lastError = e;
            }
            
            // Try CORS proxies
            for (let i = 0; i < CONFIG.corsProxies.length; i++) {
                const proxy = CONFIG.corsProxies[i];
                const proxyUrl = proxy + encodeURIComponent(url);
                
                try {
                    debugLog(`Trying proxy ${i + 1}: ${proxy}`);
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const xmlText = await response.text();
                        debugLog(`Proxy ${i + 1} successful, response length: ${xmlText.length}`);
                        return parseVesselXML(xmlText, type);
                    }
                } catch (e) {
                    debugLog(`Proxy ${i + 1} failed: ${e.message}`);
                    lastError = e;
                }
            }
            
            throw lastError || new Error('ÊâÄÊúâÁç≤ÂèñÊñπÂºèÂùáÂ§±Êïó');
        }
        
        // =====================================================
        // PARSE VESSEL XML DATA
        // Based on: https://www.mardep.gov.hk/datagovhk/Dataspec_Vessel_arrivals_and_departures.pdf
        // =====================================================
        function parseVesselXML(xmlText, type) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const data = [];
            
            // Check for parse errors
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                debugLog('XML parse error: ' + parseError.textContent);
                return data;
            }
            
            // Debug: log root element
            debugLog(`Root element: ${xmlDoc.documentElement?.tagName}`);
            
            // Try different possible record element names
            const recordSelectors = [
                'Record', 'record', 'RECORD',
                'Vessel', 'vessel', 'VESSEL',
                'Row', 'row', 'ROW',
                'Item', 'item', 'ITEM',
                'entry', 'Entry', 'ENTRY'
            ];
            
            let records = [];
            for (const selector of recordSelectors) {
                records = xmlDoc.getElementsByTagName(selector);
                if (records.length > 0) {
                    debugLog(`Found ${records.length} records using selector: ${selector}`);
                    break;
                }
            }
            
            // If no records found, try to parse children of root
            if (records.length === 0) {
                const root = xmlDoc.documentElement;
                if (root && root.children.length > 0) {
                    debugLog(`Using root children: ${root.children.length} elements`);
                    records = root.children;
                }
            }
            
            // Parse each record
            for (let i = 0; i < records.length; i++) {
                const record = parseVesselRecord(records[i], type);
                if (record.vesselName) {
                    data.push(record);
                }
            }
            
            debugLog(`Parsed ${data.length} valid records of type: ${type}`);
            return data;
        }
        
        // =====================================================
        // PARSE SINGLE VESSEL RECORD
        // Field names based on data specification PDF
        // =====================================================
        function parseVesselRecord(element, type) {
            // Helper function to get value from multiple possible tag names
            const getVal = (names) => {
                for (const name of names) {
                    // Try querySelector
                    let el = element.querySelector(name);
                    if (!el) {
                        // Try getElementsByTagName
                        const elements = element.getElementsByTagName(name);
                        if (elements.length > 0) el = elements[0];
                    }
                    if (el && el.textContent) {
                        return el.textContent.trim();
                    }
                }
                return '';
            };
            
            // Field mappings based on data specification
            // For arrivals (RP05005i): VESSEL_NAME, ARRIVAL_TIME, ANCHORAGE, SHIP_TYPE, CALL_SIGN, AGENT_NAME, REMARK
            // For departures (RP05006i): VESSEL_NAME, ATD_TIME, LAST_BERTH, SHIP_TYPE, CALL_SIGN, AGENT_NAME
            
            const vesselName = getVal([
                'VESSEL_NAME', 'Vessel_Name', 'vessel_name', 'VesselName', 'vesselName',
                'SHIP_NAME', 'Ship_Name', 'ship_name', 'ShipName', 'shipName',
                'NAME', 'Name', 'name'
            ]);
            
            let time = '';
            if (type === 'arrival') {
                time = getVal([
                    'ARRIVAL_TIME', 'Arrival_Time', 'arrival_time', 'ArrivalTime', 'arrivalTime',
                    'ATA_TIME', 'ATA', 'ata', 'ETA', 'eta'
                ]);
            } else {
                time = getVal([
                    'ATD_TIME', 'Atd_Time', 'atd_time', 'AtdTime', 'atdTime',
                    'DEPARTURE_TIME', 'Departure_Time', 'departure_time', 'DepartureTime', 'departureTime',
                    'ETD', 'etd'
                ]);
            }
            
            const location = type === 'arrival' 
                ? getVal(['ANCHORAGE', 'Anchorage', 'anchorage', 'LOCATION', 'Location', 'location', 'BERTH', 'Berth', 'berth'])
                : getVal(['LAST_BERTH', 'Last_Berth', 'last_berth', 'LastBerth', 'lastBerth', 'BERTH', 'Berth', 'berth']);
            
            return {
                vesselName: vesselName,
                type: type === 'arrival' ? 'ÊäµÊ∏Ø' : 'Èõ¢Ê∏Ø',
                time: time,
                location: location,
                shipType: getVal(['SHIP_TYPE', 'Ship_Type', 'ship_type', 'ShipType', 'shipType', 'TYPE', 'Type', 'type']),
                callSign: getVal(['CALL_SIGN', 'Call_Sign', 'call_sign', 'CallSign', 'callSign']),
                agentName: getVal(['AGENT_NAME', 'Agent_Name', 'agent_name', 'AgentName', 'agentName', 'AGENT', 'Agent', 'agent']),
                remark: getVal(['REMARK', 'Remark', 'remark', 'REMARKS', 'Remarks', 'remarks'])
            };
        }
        
        // =====================================================
        // DISPLAY RESULTS
        // =====================================================
        function displayResults(data, searchTerm) {
            hideLoading();
            currentData = data;
            
            if (data.length === 0) {
                showNoResults();
                document.getElementById('exportBtn').disabled = true;
                return;
            }
            
            hideNoResults();
            showSuccess(`ÊâæÂà∞ ${data.length} Á≠ÜË®òÈåÑ`);
            
            displayStats(data);
            createTable(data, searchTerm);
            
            document.getElementById('exportBtn').disabled = false;
        }
        
        // =====================================================
        // DISPLAY STATISTICS
        // =====================================================
        function displayStats(data) {
            const arrivals = data.filter(r => r.type === 'ÊäµÊ∏Ø').length;
            const departures = data.filter(r => r.type === 'Èõ¢Ê∏Ø').length;
            
            const statsHtml = `
                <div class="stat-item">
                    <div class="value">${data.length}</div>
                    <div class="label">Á∏ΩË®òÈåÑÊï∏</div>
                </div>
                <div class="stat-item">
                    <div class="value">${arrivals}</div>
                    <div class="label">ÊäµÊ∏Ø</div>
                </div>
                <div class="stat-item">
                    <div class="value">${departures}</div>
                    <div class="label">Èõ¢Ê∏Ø</div>
                </div>
            `;
            
            const stats = document.getElementById('stats');
            stats.innerHTML = statsHtml;
            stats.style.display = 'grid';
        }
        
        // =====================================================
        // CREATE RESULTS TABLE
        // =====================================================
        function createTable(data, searchTerm) {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const tableWrapper = document.getElementById('tableWrapper');
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Define columns with Chinese labels
            const columns = [
                { key: 'vesselName', label: 'ËàπÈöªÂêçÁ®±' },
                { key: 'type', label: 'È°ûÂûã' },
                { key: 'time', label: 'ÊôÇÈñì' },
                { key: 'location', label: '‰ΩçÁΩÆ' },
                { key: 'shipType', label: 'ËàπËà∂È°ûÂûã' },
                { key: 'callSign', label: 'ÂëºËôü' },
                { key: 'agentName', label: '‰ª£ÁêÜ' }
            ];
            
            // Add recordDate column for historical searches
            if (data.some(item => item.recordDate)) {
                columns.splice(3, 0, { key: 'recordDate', label: 'Ë®òÈåÑÊó•Êúü' });
            }
            
            // Create header
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.label;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            // Create rows
            data.forEach(record => {
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value = record[col.key] || '-';
                    
                    if (col.key === 'type') {
                        const badge = document.createElement('span');
                        badge.className = `badge ${value === 'ÊäµÊ∏Ø' ? 'badge-arrival' : 'badge-departure'}`;
                        badge.textContent = value;
                        td.appendChild(badge);
                    } else {
                        td.textContent = value;
                        
                        // Highlight search term
                        if (searchTerm && value.toString().toUpperCase().includes(searchTerm.toUpperCase())) {
                            td.classList.add('highlight');
                        }
                    }
                    
                    row.appendChild(td);
                });
                
                tableBody.appendChild(row);
            });
            
            tableWrapper.classList.add('show');
        }
        
        // =====================================================
        // EXPORT TO CSV
        // =====================================================
        function exportToCSV() {
            if (currentData.length === 0) return;
            
            const columns = ['vesselName', 'type', 'time', 'location', 'shipType', 'callSign', 'agentName', 'recordDate'];
            const headers = ['ËàπÈöªÂêçÁ®±', 'È°ûÂûã', 'ÊôÇÈñì', '‰ΩçÁΩÆ', 'ËàπËà∂È°ûÂûã', 'ÂëºËôü', '‰ª£ÁêÜ', 'Ë®òÈåÑÊó•Êúü'];
            
            // BOM for Excel to recognize UTF-8
            let csv = '\uFEFF' + headers.join(',') + '\n';
            
            currentData.forEach(row => {
                const values = columns.map(col => {
                    const value = row[col] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ËàπÈöªË≥áÊñô-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // =====================================================
        // CLEAR FUNCTIONS
        // =====================================================
        function clearSearch() {
            document.getElementById('vesselNameRealtime').value = '';
            document.getElementById('vesselNameHistorical').value = '';
            document.getElementById('dataTypeRealtime').value = 'both';
            document.getElementById('dataTypeBydate').value = 'both';
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDateHistorical').value = yesterday;
            document.getElementById('endDateHistorical').value = today;
            document.getElementById('dateBydate').value = today;
            
            clearResults();
        }
        
        function clearResults() {
            currentData = [];
            document.getElementById('tableWrapper').classList.remove('show');
            document.getElementById('stats').style.display = 'none';
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('debugPanel').classList.remove('show');
            hideNoResults();
            clearMessages();
        }
        
        // =====================================================
        // UI HELPER FUNCTIONS
        // =====================================================
        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('tableWrapper').classList.remove('show');
            document.getElementById('stats').style.display = 'none';
            hideNoResults();
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function updateProgress(message) {
            document.getElementById('progressInfo').textContent = message;
        }
        
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
        }
        
        function showInfo(message) {
            const el = document.getElementById('infoMessage');
            el.textContent = message;
            el.classList.add('show');
        }
        
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.add('show');
        }
        
        function clearMessages() {
            document.querySelectorAll('.message').forEach(el => el.classList.remove('show'));
        }
        
        function showNoResults() {
            document.getElementById('noResults').classList.add('show');
        }
        
        function hideNoResults() {
            document.getElementById('noResults').classList.remove('show');
        }
        
        // Debug logging (visible in debug panel)
        function debugLog(message) {
            console.log(message);
            const debugPanel = document.getElementById('debugPanel');
            const debugContent = document.getElementById('debugContent');
            debugContent.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            debugPanel.classList.add('show');
        }
    </script>
</body>
</html>
