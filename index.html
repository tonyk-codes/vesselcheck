<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海事處船隻進出港資料查詢 V5.5</title>
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #2b6cb0;
            --bg: #f7fafc;
            --border: #e2e8f0;
            --text: #2d3748;
            --success: #38a169;
            --error: #e53e3e;
            --warning: #dd6b20;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 16px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 18px; font-weight: 600; }

        /* Main */
        main { flex: 1; padding: 20px 0; }

        /* Components */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .card-header {
            background: #edf2f7;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body { padding: 16px; }

        /* Tabs */
        .search-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
        .tab-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid transparent;
            background: transparent;
            color: #718096;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--secondary); background: #ebf8ff; }
        .tab-btn.active {
            background: var(--secondary);
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Forms */
        .search-form { display: none; }
        .search-form.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
        .btn {
            padding: 10px 24px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-primary:hover { background: #2c5282; }
        .btn-secondary { background: #cbd5e0; color: #4a5568; }
        .btn-secondary:hover { background: #a0aec0; }

        /* Diagnostics & Status */
        .status-panel {
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            display: none;
        }
        .status-panel.show { display: block; }
        .status-line { margin-bottom: 4px; display: flex; gap: 8px; }
        .status-time { color: #718096; min-width: 70px; }
        .status-msg { flex: 1; }
        .status-success { color: #68d391; }
        .status-error { color: #fc8181; }
        .status-warn { color: #f6ad55; }
        .status-info { color: #63b3ed; }
        .status-header { border-bottom: 1px solid #4a5568; padding-bottom: 4px; margin-bottom: 8px; font-weight: bold; color: #fff; }

        /* Table */
        .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 6px; display: none; }
        .table-container.show { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        th {
            background: #f7fafc;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
        }
        td { padding: 10px; border-bottom: 1px solid var(--border); color: #2d3748; }
        tr:hover { background: #f0fff4; }
        
        /* Badges & Highlights */
        .badge { padding: 3px 8px; border-radius: 99px; font-size: 10px; font-weight: 600; }
        .badge-arrival { background: #c6f6d5; color: #22543d; }
        .badge-departure { background: #fed7d7; color: #822727; }
        .highlight { background: #fefcbf; font-weight: bold; }

        /* Loading */
        .loading-overlay {
            display: none;
            padding: 40px;
            text-align: center;
        }
        .loading-overlay.show { display: block; }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid #e2e8f0; border-top-color: var(--secondary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state {
            text-align: center; padding: 40px; color: #718096; display: none;
        }
        .empty-state.show { display: block; }

        /* Footer */
        footer { background: #2d3748; color: #cbd5e0; padding: 20px 0; margin-top: auto; font-size: 12px; }
        footer a { color: #90cdf4; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <h1>海事處船隻進出港資料查詢 <span style="font-size: 12px; opacity: 0.7; margin-left: 10px;">V5.5</span></h1>
    </div>
</header>

<main>
    <div class="container">
        <!-- Search Config -->
        <div class="card">
            <div class="card-header">
                <span>查詢設定</span>
            </div>
            <div class="card-body">
                <div class="search-tabs">
                    <button class="tab-btn active" onclick="switchMode('realtime')" id="btn-realtime">即時查詢（過去36小時）</button>
                    <button class="tab-btn" onclick="switchMode('historical')" id="btn-historical">歷史資料查詢</button>
                </div>

                <!-- Realtime Form -->
                <div id="form-realtime" class="search-form active">
                    <div class="form-row">
                        <div class="form-group">
                            <label>船隻名稱 (選填)</label>
                            <input type="text" id="rt-vessel" placeholder="例如: COTAI WATER JET">
                        </div>
                        <div class="form-group">
                            <label>進出類型</label>
                            <select id="rt-type">
                                <option value="all">全部 (抵港 + 離港)</option>
                                <option value="arrival">僅抵港</option>
                                <option value="departure">僅離港</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Historical Form -->
                <div id="form-historical" class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>船隻名稱 (選填)</label>
                            <input type="text" id="hist-vessel" placeholder="例如: STAR PISCES">
                        </div>
                        <div class="form-group">
                            <label>開始日期</label>
                            <input type="date" id="hist-start">
                        </div>
                        <div class="form-group">
                            <label>結束日期</label>
                            <input type="date" id="hist-end">
                        </div>
                        <div class="form-group">
                            <label>進出類型</label>
                            <select id="hist-type">
                                <option value="all">全部 (抵港 + 離港)</option>
                                <option value="arrival">僅抵港</option>
                                <option value="departure">僅離港</option>
                            </select>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #718096; margin-top: 8px;">注意：歷史查詢範圍最多 5 天。</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="executeSearch()">開始搜尋</button>
                    <button class="btn btn-secondary" onclick="resetForm()">重置條件</button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="card">
            <div class="card-header">
                <span>搜尋結果</span>
                <span id="result-count" style="font-size: 12px; background: #e2e8f0; padding: 2px 8px; border-radius: 12px; color: #4a5568;">0 筆</span>
            </div>
            <div class="card-body">
                <!-- Status Panel (New) -->
                <div id="status-panel" class="status-panel"></div>

                <!-- Loading -->
                <div id="loading" class="loading-overlay">
                    <div class="spinner"></div>
                    <p>正在連線至海事處資料庫...</p>
                </div>

                <!-- Table -->
                <div id="table-container" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>狀態</th>
                                <th>船隻名稱</th>
                                <th>時間</th>
                                <th>位置</th>
                                <th>船舶類型</th>
                                <th>呼號</th>
                                <th>代理</th>
                            </tr>
                        </thead>
                        <tbody id="result-body"></tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state">
                    <p>請輸入條件並點擊搜尋</p>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="container">
        <div>
            資料來源: <a href="https://data.gov.hk/tc-data/dataset/hk-md-mardep-vessel-arrivals-and-departures" target="_blank">資料一線通 - 海事處</a><br>
            Real-time Source: RP05005i.XML / RP05505i.XML
        </div>
    </div>
</footer>

<script>
    // --- Config ---
    const CONFIG = {
        urls: {
            arrival: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML',
            departure: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05505i.XML',
            historyBase: 'https://api.data.gov.hk/v1/historical-archive/get-file'
        },
        proxies: [
            url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            url => `https://corsproxy.io/?${encodeURIComponent(url)}`
        ]
    };

    let currentMode = 'realtime';

    // --- Init ---
    window.onload = () => {
        const today = new Date();
        const yest = new Date(today);
        yest.setDate(yest.getDate() - 1);
        
        document.getElementById('hist-end').valueAsDate = today;
        document.getElementById('hist-start').valueAsDate = yest;
    };

    // --- UI Control ---
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('btn-realtime').classList.toggle('active', mode === 'realtime');
        document.getElementById('btn-historical').classList.toggle('active', mode === 'historical');
        document.getElementById('form-realtime').classList.toggle('active', mode === 'realtime');
        document.getElementById('form-historical').classList.toggle('active', mode === 'historical');
        
        resetResults();
    }

    function resetForm() {
        document.getElementById('rt-vessel').value = '';
        document.getElementById('hist-vessel').value = '';
        resetResults();
        log('系統已重置', 'info');
    }

    function resetResults() {
        document.getElementById('result-body').innerHTML = '';
        document.getElementById('table-container').classList.remove('show');
        document.getElementById('empty-state').classList.add('show');
        document.getElementById('result-count').textContent = '0 筆';
        document.getElementById('status-panel').innerHTML = '';
        document.getElementById('status-panel').classList.remove('show');
    }

    // --- Logging System ---
    function log(msg, type = 'info') {
        const panel = document.getElementById('status-panel');
        const time = new Date().toLocaleTimeString('zh-HK', { hour12: false });
        const div = document.createElement('div');
        div.className = 'status-line';
        
        let colorClass = 'status-info';
        if (type === 'success') colorClass = 'status-success';
        if (type === 'error') colorClass = 'status-error';
        if (type === 'header') colorClass = 'status-header';

        if (type === 'header') {
            div.innerHTML = `<div class="status-header" style="width:100%">${msg}</div>`;
        } else {
            div.innerHTML = `<span class="status-time">[${time}]</span><span class="status-msg ${colorClass}">${msg}</span>`;
        }
        
        panel.appendChild(div);
        panel.scrollTop = panel.scrollHeight;
        panel.classList.add('show');
    }

    // --- Core Search Logic ---
    async function executeSearch() {
        resetResults();
        document.getElementById('loading').classList.add('show');
        document.getElementById('empty-state').classList.remove('show');
        
        try {
            if (currentMode === 'realtime') {
                await doRealtimeSearch();
            } else {
                await doHistoricalSearch();
            }
        } catch (e) {
            log(`嚴重錯誤: ${e.message}`, 'error');
        } finally {
            document.getElementById('loading').classList.remove('show');
        }
    }

    // --- Realtime Search ---
    async function doRealtimeSearch() {
        const type = document.getElementById('rt-type').value;
        const filterName = document.getElementById('rt-vessel').value.trim().toUpperCase();
        let results = [];

        log('=== 開始即時查詢 (過去36小時) ===', 'header');

        if (type === 'all' || type === 'arrival') {
            log(`準備下載抵港資料: ${CONFIG.urls.arrival}`);
            const arrivals = await fetchAndParse(CONFIG.urls.arrival, '抵港');
            results = results.concat(arrivals);
        }

        if (type === 'all' || type === 'departure') {
            log(`準備下載離港資料: ${CONFIG.urls.departure}`);
            const departures = await fetchAndParse(CONFIG.urls.departure, '離港');
            results = results.concat(departures);
        }

        log(`原始資料共取得 ${results.length} 筆`, 'info');

        // Filter
        if (filterName) {
            results = results.filter(item => item.vessel.includes(filterName));
            log(`關鍵字 "${filterName}" 篩選後剩餘 ${results.length} 筆`, 'success');
        }

        renderTable(results, filterName);
    }

    // --- Historical Search ---
    async function doHistoricalSearch() {
        const startDate = new Date(document.getElementById('hist-start').value);
        const endDate = new Date(document.getElementById('hist-end').value);
        const type = document.getElementById('hist-type').value;
        const filterName = document.getElementById('hist-vessel').value.trim().toUpperCase();
        
        // Date Validation
        if (startDate > endDate) {
            log('錯誤: 開始日期不能晚於結束日期', 'error');
            return;
        }
        const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        if (diffDays > 5) {
            log('錯誤: 歷史查詢限制範圍為 5 天', 'error');
            return;
        }

        // Set strict filter range (Start of StartDate to End of EndDate)
        const filterStart = new Date(startDate); filterStart.setHours(0,0,0,0);
        const filterEnd = new Date(endDate); filterEnd.setHours(23,59,59,999);
        
        log(`=== 開始歷史查詢: ${startDate.toISOString().split('T')[0]} 至 ${endDate.toISOString().split('T')[0]} ===`, 'header');
        log(`注意: 系統將根據 "船隻實際進出時間" 進行精確篩選`, 'warn');

        let results = [];
        let loopDate = new Date(startDate);
        
        // Fetch loop (fetching by file date)
        while (loopDate <= endDate) {
            const dateStr = loopDate.toISOString().split('T')[0].replace(/-/g, '');
            log(`正在搜尋日期檔案: ${dateStr}...`, 'info');
            
            // Try standard time slots to catch most files
            const timeSlots = ['0800', '1600', '2359']; 
            
            for (let slot of timeSlots) {
                const timestamp = `${dateStr}-${slot}`;
                
                if (type === 'all' || type === 'arrival') {
                    const url = `${CONFIG.urls.historyBase}?url=${encodeURIComponent(CONFIG.urls.arrival)}&time=${timestamp}`;
                    const items = await fetchAndParse(url, '抵港', true); // Silent mode
                    results = results.concat(items);
                }
                if (type === 'all' || type === 'departure') {
                    const url = `${CONFIG.urls.historyBase}?url=${encodeURIComponent(CONFIG.urls.departure)}&time=${timestamp}`;
                    const items = await fetchAndParse(url, '離港', true); // Silent mode
                    results = results.concat(items);
                }
            }
            
            loopDate.setDate(loopDate.getDate() + 1);
        }

        // Remove duplicates (same vessel, same time, same type)
        const uniqueResults = [];
        const seen = new Set();
        results.forEach(item => {
            const key = `${item.vessel}|${item.time}|${item.type}`;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueResults.push(item);
            }
        });

        log(`檔案下載完成，原始記錄共 ${uniqueResults.length} 筆`, 'info');
        log(`正在進行時間篩選 (${filterStart.toLocaleString()} - ${filterEnd.toLocaleString()})...`);

        // Final Filter: Time Range AND Name
        const finalResults = uniqueResults.filter(item => {
            // Parse item time (e.g. 25-JAN-2026 13:33)
            const itemTime = parseXMLDate(item.time);
            
            if (!itemTime) return false; // Invalid date in XML
            
            const timeMatch = itemTime >= filterStart && itemTime <= filterEnd;
            const nameMatch = filterName ? item.vessel.includes(filterName) : true;
            
            return timeMatch && nameMatch;
        });

        log(`篩選完成: 顯示 ${finalResults.length} 筆資料`, 'success');
        renderTable(finalResults, filterName);
    }

    // --- Fetch & Parser ---
    async function fetchAndParse(targetUrl, typeLabel, silent = false) {
        let xmlText = null;
        let successMethod = '';

        // 1. Try Direct
        if (!silent) log(`嘗試直接連線...`);
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const resp = await fetch(targetUrl, { signal: controller.signal });
            clearTimeout(timeoutId);
            if (resp.ok) {
                xmlText = await resp.text();
                successMethod = 'Direct';
            } else {
                if (!silent) log(`直接連線失敗 (Status ${resp.status})`, 'warn');
            }
        } catch (e) {
            if (!silent) log(`直接連線錯誤: ${e.message}`, 'warn');
        }

        // 2. Try Proxies if Direct failed
        if (!xmlText) {
            for (let i = 0; i < CONFIG.proxies.length; i++) {
                if (!silent) log(`嘗試代理伺服器 ${i+1}...`);
                try {
                    const proxyUrl = CONFIG.proxies[i](targetUrl);
                    const resp = await fetch(proxyUrl);
                    if (resp.ok) {
                        xmlText = await resp.text();
                        successMethod = `Proxy ${i+1}`;
                        break;
                    }
                } catch (e) { /* ignore */ }
            }
        }

        if (!xmlText) {
            if (!silent) log(`❌ 無法取得資料: ${targetUrl}`, 'error');
            return [];
        }

        if (!silent) log(`✔ 下載成功 (${successMethod})，正在解析 XML...`, 'success');
        return parseXML(xmlText, typeLabel);
    }

    function parseXML(text, typeLabel) {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/xml");
            
            // Check for parse errors
            if (doc.querySelector("parsererror")) {
                console.error("XML Parse Error");
                return [];
            }

            // Handle different root structures (G_SQL1, ROW, Record)
            const nodes = doc.querySelectorAll('*'); 
            const items = [];
            
            // Heuristic to find record nodes: Look for elements having VESSEL_NAME
            nodes.forEach(node => {
                const vesselNode = findChild(node, ['VESSEL_NAME', 'Vessel_Name', 'VesselName']);
                if (vesselNode) {
                    const timeKey = typeLabel === '抵港' ? ['ARRIVAL_TIME', 'Arrival_Time'] : ['ATD_TIME', 'DEPARTURE_TIME'];
                    const locKey = typeLabel === '抵港' ? ['CURRENT_LOCATION', 'ANCHORAGE'] : ['LAST_BERTH'];
                    
                    items.push({
                        type: typeLabel,
                        vessel: vesselNode.textContent || '',
                        time: findChildContent(node, timeKey),
                        location: findChildContent(node, locKey),
                        shipType: findChildContent(node, ['SHIP_TYPE', 'Ship_Type']),
                        callSign: findChildContent(node, ['CALL_SIGN', 'Call_Sign']),
                        agent: findChildContent(node, ['AGENT_NAME', 'Agent_Name'])
                    });
                }
            });

            return items;
        } catch (e) {
            console.error("Parse logic error", e);
            return [];
        }
    }

    // Helper to find child strictly case insensitive
    function findChild(parent, possibleNames) {
        for (let name of possibleNames) {
            for (let child of parent.children) {
                if (child.tagName.toUpperCase() === name.toUpperCase()) return child;
            }
        }
        return null;
    }

    function findChildContent(parent, names) {
        const node = findChild(parent, names);
        return node ? node.textContent.trim() : '-';
    }

    // --- Date Parsing (Crucial for V5.5) ---
    function parseXMLDate(dateStr) {
        // Format: 25-JAN-2026 13:33
        if (!dateStr || dateStr === '-') return null;
        
        // JS Date.parse handles "25 Jan 2026 13:33" well, but "25-JAN-2026" usually works too.
        // To be safe, replace dashes with spaces.
        const cleanStr = dateStr.replace(/-/g, ' ');
        const d = new Date(cleanStr);
        return isNaN(d) ? null : d;
    }

    // --- Render ---
    function renderTable(data, highlightTerm) {
        const tbody = document.getElementById('result-body');
        document.getElementById('result-count').textContent = `${data.length} 筆`;
        
        if (data.length === 0) {
            document.getElementById('table-container').classList.remove('show');
            document.getElementById('empty-state').classList.add('show');
            document.querySelector('#empty-state p').textContent = "沒有符合條件的資料";
            return;
        }

        // Sort by Time (Newest first)
        data.sort((a, b) => {
            const dA = parseXMLDate(a.time) || new Date(0);
            const dB = parseXMLDate(b.time) || new Date(0);
            return dB - dA;
        });

        data.forEach(item => {
            const row = document.createElement('tr');
            
            // Highlight helper
            const hl = (txt) => {
                if (!highlightTerm || !txt) return txt;
                if (txt.includes(highlightTerm)) return `<span class="highlight">${txt}</span>`;
                return txt;
            };

            const badgeClass = item.type === '抵港' ? 'badge-arrival' : 'badge-departure';

            row.innerHTML = `
                <td><span class="badge ${badgeClass}">${item.type}</span></td>
                <td>${hl(item.vessel)}</td>
                <td>${item.time}</td>
                <td>${item.location}</td>
                <td>${item.shipType}</td>
                <td>${item.callSign}</td>
                <td>${item.agent}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('table-container').classList.add('show');
    }
</script>
</body>
</html>
