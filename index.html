<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海事處船隻進出港資料查詢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            background: #f7fafc;
            color: #1a202c;
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        /* Header */
        header {
            background: #1a365d;
            color: white;
            padding: 16px 0;
        }
        
        header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Main Content */
        main {
            flex: 1;
            padding: 20px 0;
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: #edf2f7;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }
        
        .card-body {
            padding: 16px;
        }
        
        /* Search Tabs */
        .search-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            border-color: #3182ce;
            color: #3182ce;
        }
        
        .tab-btn.active {
            background: #3182ce;
            border-color: #3182ce;
            color: white;
        }
        
        /* Search Form */
        .search-form {
            display: none;
        }
        
        .search-form.active {
            display: block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 6px;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px 12px;
            font-size: 13px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .form-hint {
            font-size: 12px;
            color: #718096;
            margin-bottom: 16px;
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3182ce;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2b6cb0;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-item .value {
            font-size: 20px;
            font-weight: 700;
            color: #1a365d;
        }
        
        .stat-item .label {
            font-size: 11px;
            color: #718096;
            margin-top: 2px;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading p {
            font-size: 13px;
            color: #718096;
        }
        
        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message.error {
            background: #fed7d7;
            color: #c53030;
            border-left: 3px solid #c53030;
        }
        
        .message.success {
            background: #c6f6d5;
            color: #276749;
            border-left: 3px solid #38a169;
        }
        
        /* Log Panel */
        .log-panel {
            background: #1a202c;
            color: #a0aec0;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            max-height: 180px;
            overflow-y: auto;
            margin-bottom: 16px;
            display: none;
        }
        
        .log-panel.show {
            display: block;
        }
        
        .log-panel .log-entry {
            margin-bottom: 2px;
            line-height: 1.5;
        }
        
        .log-panel .log-time {
            color: #718096;
        }
        
        .log-panel .log-success {
            color: #68d391;
        }
        
        .log-panel .log-error {
            color: #fc8181;
        }
        
        .log-panel .log-info {
            color: #63b3ed;
        }
        
        .log-panel .log-warn {
            color: #f6ad55;
        }
        
        .log-panel .log-header {
            color: #b794f4;
            font-weight: bold;
            margin-top: 6px;
            margin-bottom: 4px;
        }
        
        .log-panel .log-summary {
            color: #68d391;
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #4a5568;
        }
        
        /* Table */
        .table-wrapper {
            overflow-x: auto;
            display: none;
        }
        
        .table-wrapper.show {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        thead {
            background: #edf2f7;
        }
        
        th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            font-size: 11px;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            color: #1a202c;
        }
        
        tbody tr:hover {
            background: #f7fafc;
        }
        
        .highlight {
            background: #fefcbf !important;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
        }
        
        .badge-arrival {
            background: #c6f6d5;
            color: #276749;
        }
        
        .badge-departure {
            background: #fed7d7;
            color: #c53030;
        }
        
        /* No Results */
        .no-results {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .no-results.show {
            display: block;
        }
        
        .no-results h3 {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .no-results p {
            font-size: 12px;
            color: #718096;
        }
        
        /* Footer */
        footer {
            background: #2d3748;
            color: #a0aec0;
            padding: 16px 0;
            margin-top: auto;
        }
        
        footer .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .footer-links {
            font-size: 12px;
            line-height: 1.8;
        }
        
        .footer-links a {
            color: #90cdf4;
            text-decoration: none;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        .footer-version {
            font-size: 12px;
            color: #718096;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .search-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                text-align: center;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                min-width: 100px;
                text-align: center;
            }
            
            footer .container {
                flex-direction: column;
                gap: 12px;
            }
            
            .footer-version {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>海事處船隻進出港資料查詢</h1>
        </div>
    </header>
    
    <main>
        <div class="container">
            <!-- Search Card -->
            <div class="card">
                <div class="card-header">查詢選項</div>
                <div class="card-body">
                    <!-- Search Mode Tabs -->
                    <div class="search-tabs">
                        <button class="tab-btn active" data-mode="realtime" onclick="switchMode('realtime')">
                            即時查詢（過去36小時）
                        </button>
                        <button class="tab-btn" data-mode="historical" onclick="switchMode('historical')">
                            歷史資料查詢
                        </button>
                        <button class="tab-btn" data-mode="bydate" onclick="switchMode('bydate')">
                            按日期列出所有船隻
                        </button>
                    </div>
                    
                    <!-- Mode 1: Real-time (Last 36 hours) -->
                    <div class="search-form active" id="form-realtime">
                        <p class="form-hint">查詢過去36小時內抵港或離港的船隻資料。輸入船隻名稱可顯示其抵港/離港時間。</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vesselNameRealtime">船隻名稱（可選）</label>
                                <input type="text" id="vesselNameRealtime" placeholder="輸入船隻名稱...">
                            </div>
                            <div class="form-group">
                                <label for="dataTypeRealtime">資料類型</label>
                                <select id="dataTypeRealtime">
                                    <option value="both">抵港及離港</option>
                                    <option value="arrival">僅抵港</option>
                                    <option value="departure">僅離港</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode 2: Historical by Vessel Name -->
                    <div class="search-form" id="form-historical">
                        <p class="form-hint">輸入船隻名稱及時間範圍，查詢該船隻的歷史進出港記錄。</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vesselNameHistorical">船隻名稱 *</label>
                                <input type="text" id="vesselNameHistorical" placeholder="輸入船隻名稱..." required>
                            </div>
                            <div class="form-group">
                                <label for="startDateHistorical">開始日期</label>
                                <input type="date" id="startDateHistorical">
                            </div>
                            <div class="form-group">
                                <label for="endDateHistorical">結束日期</label>
                                <input type="date" id="endDateHistorical">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode 3: List all vessels by date -->
                    <div class="search-form" id="form-bydate">
                        <p class="form-hint">選擇日期範圍（最多5天），列出該期間所有進出港船隻。</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDateBydate">開始日期 *</label>
                                <input type="date" id="startDateBydate" required>
                            </div>
                            <div class="form-group">
                                <label for="endDateBydate">結束���期 *</label>
                                <input type="date" id="endDateBydate" required>
                            </div>
                            <div class="form-group">
                                <label for="dataTypeBydate">資料類型</label>
                                <select id="dataTypeBydate">
                                    <option value="both">抵港及離港</option>
                                    <option value="arrival">僅抵港</option>
                                    <option value="departure">僅離港</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="performSearch()">搜尋</button>
                        <button class="btn btn-secondary" onclick="clearSearch()">清除</button>
                    </div>
                </div>
            </div>
            
            <!-- Results Card -->
            <div class="card">
                <div class="card-header">搜尋結果</div>
                <div class="card-body">
                    <div class="message error" id="errorMessage"></div>
                    <div class="message success" id="successMessage"></div>
                    
                    <div class="log-panel" id="logPanel"></div>
                    
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p id="loadingText">正在獲取資料...</p>
                    </div>
                    
                    <div class="stats-row" id="stats" style="display: none;"></div>
                    
                    <div class="no-results" id="noResults">
                        <h3>沒有找到結果</h3>
                        <p>請嘗試調整搜尋條件</p>
                    </div>
                    
                    <div class="table-wrapper" id="tableWrapper">
                        <table>
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="https://data.gov.hk/tc-data/dataset/hk-md-mardep-vessel-arrivals-and-departures/resource/92cf7f6f-be58-4072-84ff-3b8c612bf204" target="_blank">在過去三十六小時抵港的船隻</a><br>
                <a href="https://data.gov.hk/tc-data/dataset/hk-md-mardep-vessel-arrivals-and-departures/resource/7cafe2bc-066f-4665-b527-d4b792f96e4a" target="_blank">在過去三十六小時離港的船隻</a>
            </div>
            <div class="footer-version">Version: V5.2</div>
        </div>
    </footer>

    <script>
        // Configuration
        const CONFIG = {
            arrivalUrl: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML',
            departureUrl: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05505i.XML',
            historicalApiBase: 'https://api.data.gov.hk/v1/historical-archive/get-file',
            corsProxies: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?'
            ]
        };
        
        let currentData = [];
        let currentMode = 'realtime';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDateHistorical').value = yesterday;
            document.getElementById('endDateHistorical').value = today;
            document.getElementById('startDateBydate').value = yesterday;
            document.getElementById('endDateBydate').value = today;
        });
        
        // Logging - Improved formatting
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const time = new Date().toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            logPanel.classList.add('show');
            console.log(`[${type}] ${message}`);
        }
        
        function logHeader(message) {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-header';
            entry.textContent = `▶ ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            logPanel.classList.add('show');
        }
        
        function logSummary(message) {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-summary';
            entry.textContent = `✓ ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
        
        function clearLog() {
            const logPanel = document.getElementById('logPanel');
            logPanel.innerHTML = '';
            logPanel.classList.remove('show');
        }
        
        // Switch search mode
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            document.querySelectorAll('.search-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`form-${mode}`).classList.add('active');
            
            clearResults();
        }
        
        // Main search function
        async function performSearch() {
            clearMessages();
            clearResults();
            clearLog();
            
            try {
                switch (currentMode) {
                    case 'realtime':
                        await searchRealtime();
                        break;
                    case 'historical':
                        await searchHistorical();
                        break;
                    case 'bydate':
                        await searchByDate();
                        break;
                }
            } catch (error) {
                console.error('Search error:', error);
                log(`錯誤: ${error.message}`, 'error');
                showError(`搜尋時發生錯誤：${error.message}`);
                hideLoading();
            }
        }
        
        // Mode 1: Real-time search
        async function searchRealtime() {
            const vesselName = document.getElementById('vesselNameRealtime').value.trim().toUpperCase();
            const dataType = document.getElementById('dataTypeRealtime').value;
            
            showLoading('正在獲取即時船隻資料...');
            logHeader('即時查詢（過去36小時）');
            
            let allData = [];
            let arrivalCount = 0;
            let departureCount = 0;
            
            if (dataType === 'both' || dataType === 'arrival') {
                log('獲取抵港資料...', 'info');
                try {
                    const arrivalData = await fetchXMLDataSimple(CONFIG.arrivalUrl, 'arrival');
                    arrivalCount = arrivalData.length;
                    allData = allData.concat(arrivalData);
                    log(`抵港: ${arrivalCount} 筆`, 'success');
                } catch (e) {
                    log(`抵港資料獲取失敗: ${e.message}`, 'error');
                }
            }
            
            if (dataType === 'both' || dataType === 'departure') {
                log('獲取離港資料...', 'info');
                try {
                    const departureData = await fetchXMLDataSimple(CONFIG.departureUrl, 'departure');
                    departureCount = departureData.length;
                    allData = allData.concat(departureData);
                    log(`離港: ${departureCount} 筆`, 'success');
                } catch (e) {
                    log(`離港資料獲取失敗: ${e.message}`, 'error');
                }
            }
            
            if (vesselName) {
                const beforeFilter = allData.length;
                allData = allData.filter(item => 
                    item.vesselName && item.vesselName.toUpperCase().includes(vesselName)
                );
                log(`篩選 "${vesselName}": ${allData.length} 筆符合`, 'info');
            }
            
            logSummary(`完成: 共 ${allData.length} 筆記錄 (抵港 ${arrivalCount}, 離港 ${departureCount})`);
            displayResults(allData, vesselName);
        }
        
        // Mode 2: Historical search
        async function searchHistorical() {
            const vesselName = document.getElementById('vesselNameHistorical').value.trim().toUpperCase();
            const startDate = document.getElementById('startDateHistorical').value;
            const endDate = document.getElementById('endDateHistorical').value;
            
            if (!vesselName) {
                showError('請輸入船隻名稱');
                return;
            }
            
            if (!startDate || !endDate) {
                showError('請選擇日期範圍');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showError('開始日期必須早於結束日期');
                return;
            }
            
            showLoading('正在獲取歷史資料...');
            logHeader(`歷史資料查詢: ${vesselName}`);
            log(`日期範圍: ${startDate} 至 ${endDate}`, 'info');
            
            const allData = await fetchHistoricalDataRange(startDate, endDate, 'both');
            
            const filtered = allData.filter(item => 
                item.vesselName && item.vesselName.toUpperCase().includes(vesselName)
            );
            
            log(`篩選 "${vesselName}": ${filtered.length} 筆符合`, 'info');
            logSummary(`完成: 找到 ${filtered.length} 筆 "${vesselName}" 的記錄`);
            
            displayResults(filtered, vesselName);
        }
        
        // Mode 3: List by date range (max 5 days)
        async function searchByDate() {
            const startDate = document.getElementById('startDateBydate').value;
            const endDate = document.getElementById('endDateBydate').value;
            const dataType = document.getElementById('dataTypeBydate').value;
            
            if (!startDate || !endDate) {
                showError('請選擇開始和結束日期');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showError('開始日期必須早於結束日期');
                return;
            }
            
            // Check 5 day limit
            const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            if (daysDiff > 5) {
                showError('日期範圍不可超過5天');
                return;
            }
            
            showLoading('正在獲取資料...');
            logHeader(`按日期查詢: ${startDate} 至 ${endDate}`);
            log(`共 ${daysDiff} 天`, 'info');
            
            const allData = await fetchHistoricalDataRange(startDate, endDate, dataType);
            
            const arrivals = allData.filter(r => r.type === '抵港').length;
            const departures = allData.filter(r => r.type === '離港').length;
            logSummary(`完成: 共 ${allData.length} 筆記錄 (抵港 ${arrivals}, 離港 ${departures})`);
            
            displayResults(allData, '');
        }
        
        // Get appropriate time slots for a date
        function getTimeSlotsForDate(dateStr) {
            const today = new Date().toISOString().split('T')[0];
            const isToday = dateStr === today;
            
            if (!isToday) {
                // For past days, fetch at multiple times to cover full day
                return ['0000', '0800', '1600', '2359'];
            }
            
            // For today, only fetch times that have passed
            const currentHour = new Date().getHours();
            const slots = [];
            
            if (currentHour >= 0) slots.push('0000');
            if (currentHour >= 8) slots.push('0800');
            if (currentHour >= 16) slots.push('1600');
            
            // If no slots available yet, use current time
            if (slots.length === 0) {
                const hourStr = currentHour.toString().padStart(2, '0') + '00';
                slots.push(hourStr);
            }
            
            return slots;
        }
        
        // Fetch historical data range
        async function fetchHistoricalDataRange(startDate, endDate, dataType = 'both') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let allData = [];
            let totalArrivals = 0;
            let totalDepartures = 0;
            
            const current = new Date(start);
            let dayCount = 0;
            const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            while (current <= end) {
                dayCount++;
                const dateStr = current.toISOString().split('T')[0];
                const dateStrCompact = dateStr.replace(/-/g, '');
                
                const timeSlots = getTimeSlotsForDate(dateStr);
                
                showLoading(`正在獲取 ${dateStr} 的資料 (${dayCount}/${totalDays})...`);
                log(`[${dayCount}/${totalDays}] ${dateStr}`, 'info');
                
                let dayArrivals = 0;
                let dayDepartures = 0;
                
                for (const time of timeSlots) {
                    const timeParam = `${dateStrCompact}-${time}`;
                    
                    if (dataType === 'both' || dataType === 'arrival') {
                        try {
                            const arrivalData = await fetchHistoricalData(CONFIG.arrivalUrl, timeParam, 'arrival');
                            arrivalData.forEach(item => {
                                item.recordDate = dateStr;
                                if (!allData.some(d => d.vesselName === item.vesselName && d.time === item.time && d.type === item.type)) {
                                    allData.push(item);
                                    dayArrivals++;
                                }
                            });
                        } catch (e) {
                            // Silent fail for individual time slots
                        }
                    }
                    
                    if (dataType === 'both' || dataType === 'departure') {
                        try {
                            const departureData = await fetchHistoricalData(CONFIG.departureUrl, timeParam, 'departure');
                            departureData.forEach(item => {
                                item.recordDate = dateStr;
                                if (!allData.some(d => d.vesselName === item.vesselName && d.time === item.time && d.type === item.type)) {
                                    allData.push(item);
                                    dayDepartures++;
                                }
                            });
                        } catch (e) {
                            // Silent fail for individual time slots
                        }
                    }
                }
                
                totalArrivals += dayArrivals;
                totalDepartures += dayDepartures;
                
                // Log day summary
                const parts = [];
                if (dataType === 'both' || dataType === 'arrival') parts.push(`抵港 ${dayArrivals}`);
                if (dataType === 'both' || dataType === 'departure') parts.push(`離港 ${dayDepartures}`);
                log(`  → ${parts.join(', ')}`, 'success');
                
                current.setDate(current.getDate() + 1);
            }
            
            return allData;
        }
        
        // Fetch historical data
        async function fetchHistoricalData(rawUrl, timeParam, type) {
            const historicalUrl = `${CONFIG.historicalApiBase}?url=${encodeURIComponent(rawUrl)}&time=${timeParam}`;
            return await fetchXMLDataSimple(historicalUrl, type, true);
        }
        
        // Fetch XML data - simplified logging
        async function fetchXMLDataSimple(url, type, silent = false) {
            // Try direct fetch first
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const xmlText = await response.text();
                    // Check if response is valid XML (not an error message)
                    if (xmlText.length > 100 && xmlText.includes('<?xml') || xmlText.includes('<RP0')) {
                        return parseVesselXML(xmlText, type);
                    }
                }
            } catch (e) {
                // Silent fail, try proxy
            }
            
            // Try CORS proxies
            for (let i = 0; i < CONFIG.corsProxies.length; i++) {
                const proxy = CONFIG.corsProxies[i];
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const xmlText = await response.text();
                        // Check if response is valid XML
                        if (xmlText.length > 100 && (xmlText.includes('<?xml') || xmlText.includes('<RP0') || xmlText.includes('<G_SQL'))) {
                            return parseVesselXML(xmlText, type);
                        }
                    }
                } catch (e) {
                    // Silent fail
                }
            }
            
            return [];
        }
        
        // Parse XML data
        function parseVesselXML(xmlText, type) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const data = [];
            
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                return data;
            }
            
            // Try G_SQL1 first, then other selectors
            const recordSelectors = ['G_SQL1', 'Record', 'record', 'RECORD', 'row', 'Row', 'ROW'];
            let records = [];
            
            for (const selector of recordSelectors) {
                records = xmlDoc.getElementsByTagName(selector);
                if (records.length > 0) break;
            }
            
            if (records.length === 0) {
                const root = xmlDoc.documentElement;
                if (root && root.children.length > 0) {
                    records = root.children;
                }
            }
            
            for (let i = 0; i < records.length; i++) {
                const record = parseVesselRecord(records[i], type);
                if (record.vesselName) {
                    data.push(record);
                }
            }
            
            return data;
        }
        
        // Parse single record
        function parseVesselRecord(element, type) {
            const getVal = (names) => {
                for (const name of names) {
                    let el = element.querySelector(name);
                    if (!el) {
                        const elements = element.getElementsByTagName(name);
                        if (elements.length > 0) el = elements[0];
                    }
                    if (el && el.textContent) {
                        return el.textContent.trim();
                    }
                }
                return '';
            };
            
            const vesselName = getVal(['VESSEL_NAME', 'Vessel_Name', 'vessel_name', 'VesselName']);
            
            let time = '';
            if (type === 'arrival') {
                time = getVal(['ARRIVAL_TIME', 'Arrival_Time', 'arrival_time', 'ArrivalTime']);
            } else {
                time = getVal(['ATD_TIME', 'Atd_Time', 'atd_time', 'AtdTime', 'DEPARTURE_TIME']);
            }
            
            let location = '';
            if (type === 'arrival') {
                location = getVal(['CURRENT_LOCATION', 'Current_Location', 'current_location', 'ANCHORAGE', 'Anchorage']);
            } else {
                location = getVal(['LAST_BERTH', 'Last_Berth', 'last_berth', 'LastBerth']);
            }
            
            return {
                vesselName: vesselName,
                type: type === 'arrival' ? '抵港' : '離港',
                time: time,
                location: location,
                shipType: getVal(['SHIP_TYPE', 'Ship_Type', 'ship_type', 'ShipType']),
                callSign: getVal(['CALL_SIGN', 'Call_Sign', 'call_sign', 'CallSign']),
                agentName: getVal(['AGENT_NAME', 'Agent_Name', 'agent_name', 'AgentName']),
                remark: getVal(['REMARK', 'Remark', 'remark'])
            };
        }
        
        // Display results
        function displayResults(data, searchTerm) {
            hideLoading();
            currentData = data;
            
            if (data.length === 0) {
                showNoResults();
                return;
            }
            
            hideNoResults();
            showSuccess(`找到 ${data.length} 筆記錄`);
            
            displayStats(data);
            createTable(data, searchTerm);
        }
        
        // Display stats
        function displayStats(data) {
            const arrivals = data.filter(r => r.type === '抵港').length;
            const departures = data.filter(r => r.type === '離港').length;
            
            const statsHtml = `
                <div class="stat-item">
                    <div class="value">${data.length}</div>
                    <div class="label">總記錄數</div>
                </div>
                <div class="stat-item">
                    <div class="value">${arrivals}</div>
                    <div class="label">抵港</div>
                </div>
                <div class="stat-item">
                    <div class="value">${departures}</div>
                    <div class="label">離港</div>
                </div>
            `;
            
            const stats = document.getElementById('stats');
            stats.innerHTML = statsHtml;
            stats.style.display = 'grid';
        }
        
        // Create table
        function createTable(data, searchTerm) {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const tableWrapper = document.getElementById('tableWrapper');
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            const columns = [
                { key: 'vesselName', label: '船隻名稱' },
                { key: 'type', label: '類型' },
                { key: 'time', label: '時間' },
                { key: 'location', label: '位置' },
                { key: 'shipType', label: '船舶類型' },
                { key: 'callSign', label: '呼號' },
                { key: 'agentName', label: '代理' }
            ];
            
            if (data.some(item => item.recordDate)) {
                columns.splice(3, 0, { key: 'recordDate', label: '記錄日期' });
            }
            
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.label;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            data.forEach(record => {
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value = record[col.key] || '-';
                    
                    if (col.key === 'type') {
                        const badge = document.createElement('span');
                        badge.className = `badge ${value === '抵港' ? 'badge-arrival' : 'badge-departure'}`;
                        badge.textContent = value;
                        td.appendChild(badge);
                    } else {
                        td.textContent = value;
                        
                        if (searchTerm && value.toString().toUpperCase().includes(searchTerm.toUpperCase())) {
                            td.classList.add('highlight');
                        }
                    }
                    
                    row.appendChild(td);
                });
                
                tableBody.appendChild(row);
            });
            
            tableWrapper.classList.add('show');
        }
        
        // Clear functions
        function clearSearch() {
            document.getElementById('vesselNameRealtime').value = '';
            document.getElementById('vesselNameHistorical').value = '';
            document.getElementById('dataTypeRealtime').value = 'both';
            document.getElementById('dataTypeBydate').value = 'both';
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDateHistorical').value = yesterday;
            document.getElementById('endDateHistorical').value = today;
            document.getElementById('startDateBydate').value = yesterday;
            document.getElementById('endDateBydate').value = today;
            
            clearResults();
        }
        
        function clearResults() {
            currentData = [];
            document.getElementById('tableWrapper').classList.remove('show');
            document.getElementById('stats').style.display = 'none';
            hideNoResults();
            clearMessages();
            clearLog();
        }
        
        // UI helpers
        function showLoading(text) {
            document.getElementById('loading').classList.add('show');
            document.getElementById('loadingText').textContent = text || '正在獲取資料...';
            document.getElementById('tableWrapper').classList.remove('show');
            document.getElementById('stats').style.display = 'none';
            hideNoResults();
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
        }
        
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.add('show');
        }
        
        function clearMessages() {
            document.querySelectorAll('.message').forEach(el => el.classList.remove('show'));
        }
        
        function showNoResults() {
            document.getElementById('noResults').classList.add('show');
        }
        
        function hideNoResults() {
            document.getElementById('noResults').classList.remove('show');
        }
    </script>
</body>
</html>
