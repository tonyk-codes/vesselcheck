<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>香港船隻查詢系統 - API 測試</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            background: #f7fafc;
            color: #1a202c;
            font-size: 14px;
            line-height: 1.5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a365d;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: #edf2f7;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }
        
        .card-body {
            padding: 16px;
        }
        
        .test-item {
            margin-bottom: 16px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .test-item h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .test-item code {
            display: block;
            font-size: 11px;
            background: #1a202c;
            color: #68d391;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            word-break: break-all;
            white-space: pre-wrap;
        }
        
        .btn {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .btn-primary {
            background: #3182ce;
            color: white;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .result-box {
            margin-top: 12px;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
        
        .result-box.show {
            display: block;
        }
        
        .result-box.success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #276749;
        }
        
        .result-box.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
        }
        
        .result-box.info {
            background: #e2e8f0;
            border: 1px solid #cbd5e0;
            color: #2d3748;
        }
        
        .xml-preview {
            max-height: 300px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 12px;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        
        .data-table th {
            background: #edf2f7;
            font-weight: 600;
        }
        
        .data-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-success { background: #c6f6d5; color: #276749; }
        .status-error { background: #fed7d7; color: #c53030; }
        .status-pending { background: #fefcbf; color: #975a16; }
        
        .log-panel {
            background: #1a202c;
            color: #a0aec0;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }
        
        .log-panel .log-entry {
            margin-bottom: 4px;
        }
        
        .log-panel .log-time {
            color: #718096;
        }
        
        .log-panel .log-success {
            color: #68d391;
        }
        
        .log-panel .log-error {
            color: #fc8181;
        }
        
        .log-panel .log-info {
            color: #63b3ed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚓ 香港船隻查詢系統 - API 連接測試</h1>
        
        <!-- Test 1: Direct XML URL -->
        <div class="card">
            <div class="card-header">測試 1: 直接獲取 XML 資料 (即時資料)</div>
            <div class="card-body">
                <div class="test-item">
                    <h3>抵港船隻 (RP05005i.XML)</h3>
                    <code>https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML</code>
                    <button class="btn btn-primary" onclick="testDirectFetch('arrival')">直接獲取</button>
                    <button class="btn btn-secondary" onclick="testWithProxy('arrival')">使用 CORS Proxy</button>
                    <div class="result-box" id="result-arrival"></div>
                </div>
                
                <div class="test-item">
                    <h3>離港船隻 (RP05006i.XML)</h3>
                    <code>https://www.mardep.gov.hk/e_files/en/opendata/RP05006i.XML</code>
                    <button class="btn btn-primary" onclick="testDirectFetch('departure')">直接獲取</button>
                    <button class="btn btn-secondary" onclick="testWithProxy('departure')">使用 CORS Proxy</button>
                    <div class="result-box" id="result-departure"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 2: Historical API -->
        <div class="card">
            <div class="card-header">測試 2: 歷史資料 API (data.gov.hk)</div>
            <div class="card-body">
                <div class="test-item">
                    <h3>歷史抵港資料 (使用你提供的確切 URL)</h3>
                    <code>https://api.data.gov.hk/v1/historical-archive/get-file?url=https%3A%2F%2Fwww.mardep.gov.hk%2Fe_files%2Fen%2Fopendata%2FRP05005i.XML&time=20260125-1200</code>
                    <button class="btn btn-primary" onclick="testHistoricalAPI()">測試歷史 API</button>
                    <div class="result-box" id="result-historical"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 3: Different URL formats -->
        <div class="card">
            <div class="card-header">測試 3: 不同的 URL 格式</div>
            <div class="card-body">
                <div class="test-item">
                    <h3>測試多種可能的 URL</h3>
                    <button class="btn btn-primary" onclick="testAllURLFormats()">測試所有 URL 格式</button>
                    <div class="result-box" id="result-formats"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 4: Custom URL Test -->
        <div class="card">
            <div class="card-header">測試 4: 自訂 URL 測試</div>
            <div class="card-body">
                <div class="test-item">
                    <h3>輸入任何 URL 測試</h3>
                    <input type="text" id="customUrl" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px;" 
                           value="https://api.data.gov.hk/v1/historical-archive/get-file?url=https%3A%2F%2Fwww.mardep.gov.hk%2Fe_files%2Fen%2Fopendata%2FRP05005i.XML&time=20260125-1200">
                    <button class="btn btn-primary" onclick="testCustomURL()">測試此 URL</button>
                    <button class="btn btn-secondary" onclick="testCustomWithProxy()">使用 Proxy 測試</button>
                    <div class="result-box" id="result-custom"></div>
                </div>
            </div>
        </div>
        
        <!-- Parsed Data Display -->
        <div class="card">
            <div class="card-header">解析後的資料</div>
            <div class="card-body">
                <div id="parsed-data">
                    <p style="color: #718096; font-size: 12px;">執行上方測試後，解析的資料會顯示在這裡。</p>
                </div>
            </div>
        </div>
        
        <!-- Log Panel -->
        <div class="card">
            <div class="card-header">執行日誌</div>
            <div class="card-body">
                <button class="btn btn-secondary" onclick="clearLog()">清除日誌</button>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry"><span class="log-info">系統就緒，等待測試...</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URLs to test
        const URLS = {
            arrivalDirect: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML',
            departureDirect: 'https://www.mardep.gov.hk/e_files/en/opendata/RP05006i.XML',
            historicalBase: 'https://api.data.gov.hk/v1/historical-archive/get-file'
        };
        
        // CORS Proxies to try
        const CORS_PROXIES = [
            { name: 'allorigins', url: 'https://api.allorigins.win/raw?url=' },
            { name: 'corsproxy.io', url: 'https://corsproxy.io/?' },
            { name: 'cors-anywhere', url: 'https://cors-anywhere.herokuapp.com/' }
        ];
        
        // Logging
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('logPanel').innerHTML = '<div class="log-entry"><span class="log-info">日誌已清除</span></div>';
        }
        
        function showResult(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = `result-box show ${type}`;
            el.innerHTML = message;
        }
        
        // Test 1: Direct fetch
        async function testDirectFetch(type) {
            const url = type === 'arrival' ? URLS.arrivalDirect : URLS.departureDirect;
            const resultId = `result-${type}`;
            
            log(`嘗試直接獲取: ${url}`);
            showResult(resultId, '正在獲取...', 'info');
            
            try {
                const response = await fetch(url);
                log(`回應狀態: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const text = await response.text();
                    log(`獲取成功! 資料長度: ${text.length} 字元`, 'success');
                    showResult(resultId, `<strong>✅ 成功!</strong><br>狀態: ${response.status}<br>資料長度: ${text.length} 字元<div class="xml-preview">${escapeHtml(text.substring(0, 2000))}${text.length > 2000 ? '...(截斷)' : ''}</div>`, 'success');
                    parseAndDisplayData(text, type);
                } else {
                    showResult(resultId, `<strong>❌ 失敗</strong><br>狀態: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`錯誤: ${error.message}`, 'error');
                showResult(resultId, `<strong>❌ 錯誤</strong><br>${error.message}<br><br>這可能是 CORS 問題，嘗試使用 Proxy。`, 'error');
            }
        }
        
        // Test with CORS proxy
        async function testWithProxy(type) {
            const url = type === 'arrival' ? URLS.arrivalDirect : URLS.departureDirect;
            const resultId = `result-${type}`;
            
            showResult(resultId, '正在嘗試不同的 CORS Proxies...', 'info');
            
            for (const proxy of CORS_PROXIES) {
                const proxyUrl = proxy.url + encodeURIComponent(url);
                log(`嘗試 ${proxy.name}: ${proxyUrl}`);
                
                try {
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const text = await response.text();
                        log(`${proxy.name} 成功! 資料長度: ${text.length}`, 'success');
                        showResult(resultId, `<strong>✅ 成功 (使用 ${proxy.name})</strong><br>資料長度: ${text.length} 字元<div class="xml-preview">${escapeHtml(text.substring(0, 2000))}${text.length > 2000 ? '...(截斷)' : ''}</div>`, 'success');
                        parseAndDisplayData(text, type);
                        return;
                    } else {
                        log(`${proxy.name} 失敗: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`${proxy.name} 錯誤: ${error.message}`, 'error');
                }
            }
            
            showResult(resultId, '<strong>❌ 所有 Proxy 都失敗了</strong>', 'error');
        }
        
        // Test Historical API
        async function testHistoricalAPI() {
            const resultId = 'result-historical';
            
            // Use exact URL format from user's examples
            const url = 'https://api.data.gov.hk/v1/historical-archive/get-file?url=https%3A%2F%2Fwww.mardep.gov.hk%2Fe_files%2Fen%2Fopendata%2FRP05005i.XML&time=20260125-1200';
            
            log(`測試歷史 API: ${url}`);
            showResult(resultId, '正在獲取歷史資料...', 'info');
            
            try {
                const response = await fetch(url);
                log(`回應狀態: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const text = await response.text();
                    log(`歷史 API 成功! 資料長度: ${text.length}`, 'success');
                    showResult(resultId, `<strong>✅ 成功!</strong><br>資料長度: ${text.length} 字元<div class="xml-preview">${escapeHtml(text.substring(0, 2000))}${text.length > 2000 ? '...(截斷)' : ''}</div>`, 'success');
                    parseAndDisplayData(text, 'arrival');
                } else {
                    const errorText = await response.text();
                    showResult(resultId, `<strong>❌ 失敗</strong><br>狀態: ${response.status}<br>錯誤: ${escapeHtml(errorText)}`, 'error');
                }
            } catch (error) {
                log(`歷史 API 錯誤: ${error.message}`, 'error');
                showResult(resultId, `<strong>❌ 錯誤</strong><br>${error.message}`, 'error');
            }
        }
        
        // Test all URL formats
        async function testAllURLFormats() {
            const resultId = 'result-formats';
            
            const urlsToTest = [
                'https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML',
                'https://www.mardep.gov.hk/e_files/en/opendata/RP05006i.XML',
                'https://www.mardep.gov.hk/opendata/en/vts_message_files/dat_vat.xml',
                'https://www.mardep.gov.hk/opendata/en/vts_message_files/dat_vdt.xml',
                'https://api.data.gov.hk/v1/historical-archive/get-file?url=https%3A%2F%2Fwww.mardep.gov.hk%2Fe_files%2Fen%2Fopendata%2FRP05005i.XML&time=20260125-1200',
                'https://api.data.gov.hk/v1/historical-archive/get-file?url=https%3A%2F%2Fwww.mardep.gov.hk%2Fe_files%2Fen%2Fopendata%2FRP05006i.XML&time=20260125-1200'
            ];
            
            let results = '<strong>測試結果:</strong><br><br>';
            
            for (const url of urlsToTest) {
                log(`測試: ${url}`);
                
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const text = await response.text();
                        results += `<span class="status status-success">✅ 成功</span> ${url.substring(0, 60)}... (${text.length} 字元)<br>`;
                        log(`✅ 成功: ${url}`, 'success');
                    } else {
                        results += `<span class="status status-error">��� ${response.status}</span> ${url.substring(0, 60)}...<br>`;
                        log(`❌ 失敗 (${response.status}): ${url}`, 'error');
                    }
                } catch (error) {
                    results += `<span class="status status-error">❌ CORS</span> ${url.substring(0, 60)}...<br>`;
                    log(`❌ CORS 錯誤: ${url}`, 'error');
                }
            }
            
            showResult(resultId, results, 'info');
        }
        
        // Test custom URL
        async function testCustomURL() {
            const url = document.getElementById('customUrl').value.trim();
            const resultId = 'result-custom';
            
            if (!url) {
                showResult(resultId, '請輸入 URL', 'error');
                return;
            }
            
            log(`測試自訂 URL: ${url}`);
            showResult(resultId, '正在獲取...', 'info');
            
            try {
                const response = await fetch(url);
                log(`回應狀態: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const text = await response.text();
                    log(`成功! 資料長度: ${text.length}`, 'success');
                    showResult(resultId, `<strong>✅ 成功!</strong><br>資料長度: ${text.length} 字元<div class="xml-preview">${escapeHtml(text.substring(0, 3000))}${text.length > 3000 ? '...(截斷)' : ''}</div>`, 'success');
                    parseAndDisplayData(text, 'custom');
                } else {
                    const errorText = await response.text();
                    showResult(resultId, `<strong>❌ 失敗</strong><br>狀態: ${response.status}<br>錯誤: ${escapeHtml(errorText.substring(0, 500))}`, 'error');
                }
            } catch (error) {
                log(`錯誤: ${error.message}`, 'error');
                showResult(resultId, `<strong>❌ 錯誤</strong><br>${error.message}`, 'error');
            }
        }
        
        async function testCustomWithProxy() {
            const url = document.getElementById('customUrl').value.trim();
            const resultId = 'result-custom';
            
            if (!url) {
                showResult(resultId, '請輸入 URL', 'error');
                return;
            }
            
            showResult(resultId, '正在嘗試 Proxy...', 'info');
            
            for (const proxy of CORS_PROXIES) {
                const proxyUrl = proxy.url + encodeURIComponent(url);
                log(`嘗試 ${proxy.name}`);
                
                try {
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const text = await response.text();
                        log(`${proxy.name} 成功!`, 'success');
                        showResult(resultId, `<strong>✅ 成功 (${proxy.name})</strong><br>資料長度: ${text.length} 字元<div class="xml-preview">${escapeHtml(text.substring(0, 3000))}${text.length > 3000 ? '...(截斷)' : ''}</div>`, 'success');
                        parseAndDisplayData(text, 'custom');
                        return;
                    }
                } catch (error) {
                    log(`${proxy.name} 失敗: ${error.message}`, 'error');
                }
            }
            
            showResult(resultId, '<strong>❌ 所有 Proxy 都失敗了</strong>', 'error');
        }
        
        // Parse and display XML data
        function parseAndDisplayData(xmlText, type) {
            const container = document.getElementById('parsed-data');
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Check for parse errors
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    container.innerHTML = `<p style="color: #c53030;">XML 解析錯誤: ${escapeHtml(parseError.textContent)}</p>`;
                    log('XML 解析錯誤', 'error');
                    return;
                }
                
                // Log root element info
                const root = xmlDoc.documentElement;
                log(`根元素: <${root.tagName}>, 子元素數量: ${root.children.length}`, 'info');
                
                // Try to find records
                const allElements = xmlDoc.getElementsByTagName('*');
                log(`總共 ${allElements.length} 個 XML 元素`, 'info');
                
                // List all unique tag names
                const tagNames = new Set();
                for (let i = 0; i < allElements.length; i++) {
                    tagNames.add(allElements[i].tagName);
                }
                log(`標籤名稱: ${Array.from(tagNames).join(', ')}`, 'info');
                
                // Try to extract data
                let records = [];
                
                // Try common record containers
                const recordSelectors = ['Record', 'record', 'RECORD', 'row', 'Row', 'ROW', 'item', 'Item', 'ITEM', 'vessel', 'Vessel', 'VESSEL'];
                
                for (const selector of recordSelectors) {
                    const elements = xmlDoc.getElementsByTagName(selector);
                    if (elements.length > 0) {
                        log(`找到 ${elements.length} 個 <${selector}> 記錄`, 'success');
                        
                        for (let i = 0; i < Math.min(elements.length, 50); i++) {
                            const el = elements[i];
                            const record = {};
                            
                            // Extract all child element values
                            for (let j = 0; j < el.children.length; j++) {
                                const child = el.children[j];
                                record[child.tagName] = child.textContent.trim();
                            }
                            
                            records.push(record);
                        }
                        break;
                    }
                }
                
                // If no records found, try root's direct children
                if (records.length === 0 && root.children.length > 0) {
                    log(`嘗試解析根元素的子元素`, 'info');
                    
                    for (let i = 0; i < Math.min(root.children.length, 50); i++) {
                        const el = root.children[i];
                        const record = {};
                        
                        for (let j = 0; j < el.children.length; j++) {
                            const child = el.children[j];
                            record[child.tagName] = child.textContent.trim();
                        }
                        
                        if (Object.keys(record).length > 0) {
                            records.push(record);
                        }
                    }
                }
                
                if (records.length > 0) {
                    // Create table
                    const headers = Object.keys(records[0]);
                    let tableHtml = '<table class="data-table"><thead><tr>';
                    headers.forEach(h => {
                        tableHtml += `<th>${escapeHtml(h)}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    records.forEach(record => {
                        tableHtml += '<tr>';
                        headers.forEach(h => {
                            tableHtml += `<td>${escapeHtml(record[h] || '-')}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    
                    tableHtml += '</tbody></table>';
                    
                    container.innerHTML = `<p style="color: #276749; margin-bottom: 12px;"><strong>✅ 成功解析 ${records.length} 筆記錄</strong></p>${tableHtml}`;
                    log(`成功解析 ${records.length} 筆記錄`, 'success');
                } else {
                    container.innerHTML = `<p style="color: #975a16;">無法找到記錄。XML 結構:</p><div class="xml-preview">${escapeHtml(xmlText.substring(0, 2000))}</div>`;
                    log('無法找到���錄', 'error');
                }
                
            } catch (error) {
                container.innerHTML = `<p style="color: #c53030;">解析錯誤: ${escapeHtml(error.message)}</p>`;
                log(`解析錯誤: ${error.message}`, 'error');
            }
        }
        
        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
