<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>海事處船隻進出港資料查詢</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: #f7fafc;
      color: #1a202c;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
    }

    header { background: #1a365d; color: white; padding: 16px 0; }
    header h1 { font-size: 18px; font-weight: 600; }

    main { flex: 1; padding: 20px 0; }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      background: #edf2f7;
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
      font-size: 14px;
    }

    .card-body { padding: 16px; }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group { display: flex; flex-direction: column; }

    .form-group label {
      font-size: 12px;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select {
      padding: 10px 12px;
      font-size: 13px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      transition: all 0.2s;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3182ce;
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }

    .form-group input:disabled,
    .form-group select:disabled {
      background: #edf2f7;
      color: #718096;
      cursor: not-allowed;
    }

    .form-hint {
      font-size: 12px;
      color: #718096;
      margin-bottom: 12px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #3182ce;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .btn {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary { background: #3182ce; color: white; }
    .btn-primary:hover { background: #2b6cb0; }

    .btn-secondary { background: #718096; color: white; }
    .btn-secondary:hover { background: #4a5568; }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-item {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .stat-item .value {
      font-size: 20px;
      font-weight: 700;
      color: #1a365d;
    }

    .stat-item .label {
      font-size: 11px;
      color: #718096;
      margin-top: 2px;
    }

    .loading { display: none; text-align: center; padding: 40px; }
    .loading.show { display: block; }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e2e8f0;
      border-top-color: #3182ce;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading p { font-size: 13px; color: #718096; }

    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
      display: none;
    }

    .message.show { display: block; }

    .message.error {
      background: #fed7d7;
      color: #c53030;
      border-left: 3px solid #c53030;
    }

    .message.success {
      background: #c6f6d5;
      color: #276749;
      border-left: 3px solid #38a169;
    }

    .log-panel {
      background: #1a202c;
      color: #a0aec0;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 11px;
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 16px;
      display: none;
    }

    .log-panel.show { display: block; }

    .log-panel .log-entry { margin-bottom: 2px; line-height: 1.5; }
    .log-panel .log-time { color: #718096; }
    .log-panel .log-success { color: #68d391; }
    .log-panel .log-error { color: #fc8181; }
    .log-panel .log-info { color: #63b3ed; }
    .log-panel .log-warn { color: #f6ad55; }
    .log-panel .log-header { color: #b794f4; font-weight: bold; margin-top: 6px; margin-bottom: 4px; }
    .log-panel .log-summary { color: #68d391; font-weight: bold; margin-top: 8px; padding-top: 8px; border-top: 1px solid #4a5568; }

    .table-wrapper { overflow-x: auto; display: none; }
    .table-wrapper.show { display: block; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { background: #edf2f7; }

    th {
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
      white-space: nowrap;
      font-size: 11px;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #e2e8f0;
      color: #1a202c;
    }

    tbody tr:hover { background: #f7fafc; }

    .highlight { background: #fefcbf !important; }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: 600;
      border-radius: 4px;
    }

    .badge-arrival { background: #c6f6d5; color: #276749; }
    .badge-departure { background: #fed7d7; color: #c53030; }

    .no-results { text-align: center; padding: 40px; display: none; }
    .no-results.show { display: block; }

    .no-results h3 { font-size: 14px; color: #4a5568; margin-bottom: 8px; }
    .no-results p { font-size: 12px; color: #718096; }

    footer {
      background: #2d3748;
      color: #a0aec0;
      padding: 16px 0;
      margin-top: auto;
    }

    footer .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer-links { font-size: 12px; line-height: 1.8; }
    .footer-links a { color: #90cdf4; text-decoration: none; }
    .footer-links a:hover { text-decoration: underline; }

    .footer-version { font-size: 12px; color: #718096; white-space: nowrap; }

    @media (max-width: 768px) {
      .btn-group { flex-wrap: wrap; }
      .btn { flex: 1; min-width: 120px; text-align: center; }
    }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <h1>海事處船隻進出港資料查詢</h1>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="card">
        <div class="card-header">查詢選項</div>
        <div class="card-body">
          <p class="form-hint">可選擇「最近 36 小時數據」或取消勾選以查詢歷史日期範圍（最多 20 天）。</p>

          <div class="checkbox-row">
            <input type="checkbox" id="useLast36h" checked />
            <label for="useLast36h" style="margin:0; font-size:13px; font-weight:600; color:#1a365d;">最近 36 小時數據</label>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="vesselName">船隻名稱（可選）</label>
              <input type="text" id="vesselName" placeholder="輸入船隻名稱" />
            </div>

            <div class="form-group">
              <label for="startDate">開始日期</label>
              <input type="date" id="startDate" />
            </div>

            <div class="form-group">
              <label for="endDate">結束日期</label>
              <input type="date" id="endDate" />
            </div>

            <div class="form-group">
              <label for="dataType">資料類型</label>
              <select id="dataType">
                <option value="both">抵港及離港</option>
                <option value="arrival">僅抵港</option>
                <option value="departure">僅離港</option>
              </select>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" id="searchBtn" onclick="performSearch()">搜尋</button>
            <button class="btn btn-secondary" onclick="clearSearch()">清除</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">搜尋結果</div>
        <div class="card-body">
          <div class="message error" id="errorMessage"></div>
          <div class="message success" id="successMessage"></div>

          <div class="log-panel" id="logPanel"></div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">正在獲取資料...</p>
          </div>

          <div class="stats-row" id="stats" style="display:none;"></div>

          <div class="no-results" id="noResults">
            <h3>沒有找到結果</h3>
            <p>請嘗試調整搜尋條件</p>
          </div>

          <div class="table-wrapper" id="tableWrapper">
            <table>
              <thead id="tableHead"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-links">
        <a href="https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML" target="_blank">過去三十六小時抵港的船隻</a><br />
        <a href="https://www.mardep.gov.hk/e_files/en/opendata/RP05505i.XML" target="_blank">過去三十六小時離港的船隻</a>
      </div>
      <div class="footer-version">20260202.23</div>
    </div>
  </footer>

  <script>
    const CONFIG = {
      arrivalUrl: "https://www.mardep.gov.hk/e_files/en/opendata/RP05005i.XML",
      departureUrl: "https://www.mardep.gov.hk/e_files/en/opendata/RP05505i.XML",
      historicalApiBase: "https://api.data.gov.hk/v1/historical-archive/get-file",
      corsProxies: ["https://api.allorigins.win/raw?url=", "https://corsproxy.io/?"],
      maxDays: 20,
      maxFetchAttempts: 10,
      retryBaseDelayMs: 250
    };

    let currentData = [];

    document.addEventListener("DOMContentLoaded", function () {
      const today = new Date().toISOString().split("T")[0];
      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split("T")[0];
      document.getElementById("startDate").value = yesterday;
      document.getElementById("endDate").value = today;

      const cb = document.getElementById("useLast36h");
      cb.addEventListener("change", syncDateEnabledState);

      const startEl = document.getElementById("startDate");
      startEl.addEventListener("change", function () {
        if (document.getElementById("useLast36h").checked) return;
        const endEl = document.getElementById("endDate");
        endEl.focus();
        if (typeof endEl.showPicker === "function") endEl.showPicker();
      });

      syncDateEnabledState();
    });

    function syncDateEnabledState() {
      const useLast36h = document.getElementById("useLast36h").checked;
      const startEl = document.getElementById("startDate");
      const endEl = document.getElementById("endDate");
      startEl.disabled = useLast36h;
      endEl.disabled = useLast36h;
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    function log(message, type = "info") {
      const logPanel = document.getElementById("logPanel");
      const time = new Date().toLocaleTimeString("zh-HK", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      const entry = document.createElement("div");
      entry.className = "log-entry";
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
      logPanel.classList.add("show");
    }

    function logHeader(message) {
      const logPanel = document.getElementById("logPanel");
      const entry = document.createElement("div");
      entry.className = "log-entry log-header";
      entry.textContent = `▶ ${message}`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
      logPanel.classList.add("show");
    }

    function logSummary(message) {
      const logPanel = document.getElementById("logPanel");
      const entry = document.createElement("div");
      entry.className = "log-entry log-summary";
      entry.textContent = `✓ ${message}`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    function clearLog() {
      const logPanel = document.getElementById("logPanel");
      logPanel.innerHTML = "";
      logPanel.classList.remove("show");
    }

    function clearMessages() {
      document.querySelectorAll(".message").forEach(el => el.classList.remove("show"));
    }

    function showError(message) {
      const el = document.getElementById("errorMessage");
      el.textContent = message;
      el.classList.add("show");
    }

    function showSuccess(message) {
      const el = document.getElementById("successMessage");
      el.textContent = message;
      el.classList.add("show");
    }

    function showLoading(text) {
      document.getElementById("loading").classList.add("show");
      document.getElementById("loadingText").textContent = text || "正在獲取資料...";
      document.getElementById("tableWrapper").classList.remove("show");
      document.getElementById("stats").style.display = "none";
      hideNoResults();
    }

    function hideLoading() {
      document.getElementById("loading").classList.remove("show");
    }

    function showNoResults() {
      document.getElementById("noResults").classList.add("show");
    }

    function hideNoResults() {
      document.getElementById("noResults").classList.remove("show");
    }

    function clearResults() {
      currentData = [];
      document.getElementById("tableWrapper").classList.remove("show");
      document.getElementById("stats").style.display = "none";
      hideNoResults();
      clearMessages();
      clearLog();
    }

    function validateDateRange(startDate, endDate) {
      if (!startDate || !endDate) return { valid: false, error: "請選擇開始和結束日期" };
      if (new Date(startDate) > new Date(endDate)) return { valid: false, error: "開始日期必須早於結束日期" };
      const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
      if (daysDiff > CONFIG.maxDays) return { valid: false, error: `日期範圍不可超過${CONFIG.maxDays}天` };
      return { valid: true, days: daysDiff };
    }

    function parseVesselDateTime(value) {
      if (!value) return null;
      const s = String(value).trim();
      const m1 = s.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m1) {
        const dd = Number(m1[1]);
        const mon = m1[2].toUpperCase();
        const yyyy = Number(m1[3]);
        const hh = m1[4] !== undefined ? Number(m1[4]) : 0;
        const mm = m1[5] !== undefined ? Number(m1[5]) : 0;
        const ss = m1[6] !== undefined ? Number(m1[6]) : 0;
        const map = { JAN:0, FEB:1, MAR:2, APR:3, MAY:4, JUN:5, JUL:6, AUG:7, SEP:8, OCT:9, NOV:10, DEC:11 };
        const mo = map[mon];
        if (mo === undefined) return null;
        const d = new Date(yyyy, mo, dd, hh, mm, ss);
        return Number.isNaN(d.getTime()) ? null : d;
      }
      const d2 = new Date(s);
      return Number.isNaN(d2.getTime()) ? null : d2;
    }

    function parseDateOnlyFromVesselDate(value) {
      const dt = parseVesselDateTime(value);
      if (!dt) return null;
      return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    }

    function filterBySelectedDateRange(data, startDateStr, endDateStr) {
      const start = new Date(startDateStr);
      const end = new Date(endDateStr);
      start.setHours(0, 0, 0, 0);
      end.setHours(0, 0, 0, 0);

      return data.filter(item => {
        const d = parseDateOnlyFromVesselDate(item.time ?? item.date ?? item["日期"]);
        if (!d || Number.isNaN(d.getTime())) return false;
        d.setHours(0, 0, 0, 0);
        return d >= start && d <= end;
      });
    }

    function sortByTimeAscending(data) {
      return data.slice().sort((a, b) => {
        const da = parseVesselDateTime(a.time);
        const db = parseVesselDateTime(b.time);
        const ta = da ? da.getTime() : Number.POSITIVE_INFINITY;
        const tb = db ? db.getTime() : Number.POSITIVE_INFINITY;
        if (ta !== tb) return ta - tb;
        const va = (a.vesselName || "").toUpperCase();
        const vb = (b.vesselName || "").toUpperCase();
        if (va < vb) return -1;
        if (va > vb) return 1;
        return 0;
      });
    }

    function floorToHalfHourHHMM(date) {
      const d = new Date(date.getTime());
      const mins = d.getMinutes();
      d.setMinutes(mins < 30 ? 0 : 30, 0, 0);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${hh}${mm}`;
    }

    function ymd(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function ymdCompact(dateStr) {
      return dateStr.replace(/-/g, "");
    }

    function recordKey(r) {
      return `${(r.vesselName || "").toUpperCase()}|${r.type || ""}|${r.time || ""}|${r.location || ""}|${r.callSign || ""}`;
    }

    function dedupeRecords(records) {
      const seen = new Set();
      const out = [];
      for (const r of records) {
        const k = recordKey(r);
        if (!seen.has(k)) {
          seen.add(k);
          out.push(r);
        }
      }
      return out;
    }

    async function performSearch() {
      clearMessages();
      clearResults();
      clearLog();

      const vesselName = document.getElementById("vesselName").value.trim().toUpperCase();
      const dataType = document.getElementById("dataType").value;
      const useLast36h = document.getElementById("useLast36h").checked;

      try {
        if (useLast36h) {
          logHeader("最近 36 小時數據");
          showLoading("正在獲取最近 36 小時船隻資料...");
          const data = await searchLast36Hours(vesselName, dataType);
          displayResults(data, vesselName);
          return;
        }

        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const validation = validateDateRange(startDate, endDate);
        if (!validation.valid) {
          showError(validation.error);
          return;
        }

        logHeader("歷史資料查詢");
        log(`日期範圍: ${startDate} 至 ${endDate} (${validation.days} 天)`, "info");
        showLoading("正在獲取歷史資料...");

        const allData = await fetchHistoricalDataRangeOptimized(startDate, endDate, dataType);
        let filtered = filterBySelectedDateRange(allData, startDate, endDate);

        if (vesselName) {
          filtered = filtered.filter(item => item.vesselName && item.vesselName.toUpperCase().includes(vesselName));
          log(`篩選 "${vesselName}": ${filtered.length} 筆符合`, "info");
        }

        const arrivals = filtered.filter(r => r.type === "抵港").length;
        const departures = filtered.filter(r => r.type === "離港").length;
        logSummary(`完成: 共 ${filtered.length} 筆記錄 (抵港 ${arrivals}, 離港 ${departures})`);
        displayResults(filtered, vesselName);
      } catch (error) {
        log(`錯誤: ${error.message}`, "error");
        showError(`搜尋時發生錯誤：${error.message}`);
        hideLoading();
      }
    }

    async function searchLast36Hours(vesselName, dataType) {
      let allData = [];
      let arrivalCount = 0;
      let departureCount = 0;

      if (dataType === "both" || dataType === "arrival") {
        log("獲取抵港資料...", "info");
        const arrivalData = await fetchXMLDataEnsured(CONFIG.arrivalUrl, "arrival", false);
        arrivalCount = arrivalData.length;
        allData = allData.concat(arrivalData);
        log(`抵港: ${arrivalCount} 筆`, "success");
      }

      if (dataType === "both" || dataType === "departure") {
        log("獲取離港資料...", "info");
        const departureData = await fetchXMLDataEnsured(CONFIG.departureUrl, "departure", false);
        departureCount = departureData.length;
        allData = allData.concat(departureData);
        log(`離港: ${departureCount} 筆`, "success");
      }

      if (vesselName) {
        allData = allData.filter(item => item.vesselName && item.vesselName.toUpperCase().includes(vesselName));
        log(`篩選 "${vesselName}": ${allData.length} 筆符合`, "info");
      }

      logSummary(`完成: 共 ${allData.length} 筆記錄 (抵港 ${arrivalCount}, 離港 ${departureCount})`);
      return dedupeRecords(allData);
    }

    async function fetchHistoricalDataRangeOptimized(startDate, endDate, dataType = "both") {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const today = new Date();
      const todayStr = ymd(today);

      const all = [];
      const seen = new Set();

      const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      let dayIndex = 0;

      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        dayIndex += 1;
        const dayStr = ymd(d);

        let timeHHMM = "2330";
        if (dayStr === todayStr) timeHHMM = floorToHalfHourHHMM(new Date());
        if (dayStr > todayStr) timeHHMM = floorToHalfHourHHMM(new Date());

        const timeParam = `${ymdCompact(dayStr)}-${timeHHMM}`;

        showLoading(`正在獲取 ${dayStr} 的資料 (${dayIndex}/${totalDays})...`);
        log(`[${dayIndex}/${totalDays}] ${dayStr} → 取樣點 ${timeHHMM}`, "info");

        let dayArrivals = 0;
        let dayDepartures = 0;

        if (dataType === "both" || dataType === "arrival") {
          const a = await fetchHistoricalDataEnsured(CONFIG.arrivalUrl, timeParam, "arrival");
          for (const item of a) {
            const k = recordKey(item);
            if (!seen.has(k)) {
              seen.add(k);
              all.push(item);
              dayArrivals += 1;
            }
          }
        }

        if (dataType === "both" || dataType === "departure") {
          const b = await fetchHistoricalDataEnsured(CONFIG.departureUrl, timeParam, "departure");
          for (const item of b) {
            const k = recordKey(item);
            if (!seen.has(k)) {
              seen.add(k);
              all.push(item);
              dayDepartures += 1;
            }
          }
        }

        const parts = [];
        if (dataType === "both" || dataType === "arrival") parts.push(`抵港 ${dayArrivals}`);
        if (dataType === "both" || dataType === "departure") parts.push(`離港 ${dayDepartures}`);
        log(`  → ${parts.join(", ")}`, "success");
      }

      return all;
    }

    async function fetchHistoricalDataEnsured(rawUrl, timeParam, type) {
      const historicalUrl = `${CONFIG.historicalApiBase}?url=${encodeURIComponent(rawUrl)}&time=${timeParam}`;
      const data = await fetchXMLDataEnsured(historicalUrl, type, true);
      return data;
    }

    async function fetchXMLDataEnsured(url, type, isHistorical) {
      let attempt = 0;
      while (attempt < CONFIG.maxFetchAttempts) {
        attempt += 1;
        const label = isHistorical ? "歷史API" : "即時XML";
        log(`${label} 連線中... (第 ${attempt}/${CONFIG.maxFetchAttempts} 次)`, "info");

        const data = await fetchXMLDataOnce(url, type);
        if (Array.isArray(data) && data.length > 0) return data;

        const delay = CONFIG.retryBaseDelayMs * attempt;
        log(`未取到資料，${delay}ms 後重試...`, "warn");
        await sleep(delay);
      }
      throw new Error("無法從資料來源取得任何資料（已多次重試）");
    }

    async function fetchXMLDataOnce(url, type) {
      const direct = await tryFetchAndParse(url, type);
      if (direct.length > 0) return direct;

      for (let i = 0; i < CONFIG.corsProxies.length; i++) {
        const proxyUrl = CONFIG.corsProxies[i] + encodeURIComponent(url);
        const viaProxy = await tryFetchAndParse(proxyUrl, type);
        if (viaProxy.length > 0) return viaProxy;
      }
      return [];
    }

    async function tryFetchAndParse(url, type) {
      try {
        const response = await fetch(url, { cache: "no-store" });
        if (!response.ok) return [];
        const xmlText = await response.text();
        if (xmlText.length < 80) return [];
        if (!(xmlText.includes("<?xml") || xmlText.includes("<RP0") || xmlText.includes("<G_SQL"))) return [];
        const parsed = parseVesselXML(xmlText, type);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        return [];
      }
    }

    function parseVesselXML(xmlText, type) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "text/xml");
      const data = [];

      const parseError = xmlDoc.querySelector("parsererror");
      if (parseError) return data;

      const recordSelectors = ["G_SQL1", "Record", "record", "RECORD", "row", "Row", "ROW"];
      let records = [];

      for (const selector of recordSelectors) {
        records = xmlDoc.getElementsByTagName(selector);
        if (records.length > 0) break;
      }

      if (records.length === 0) {
        const root = xmlDoc.documentElement;
        if (root && root.children && root.children.length > 0) records = root.children;
      }

      for (let i = 0; i < records.length; i++) {
        const record = parseVesselRecord(records[i], type);
        if (record.vesselName) data.push(record);
      }

      return data;
    }

    function parseVesselRecord(element, type) {
      const getVal = (names) => {
        for (const name of names) {
          let el = element.querySelector(name);
          if (!el) {
            const els = element.getElementsByTagName(name);
            if (els.length > 0) el = els[0];
          }
          if (el && el.textContent) return el.textContent.trim();
        }
        return "";
      };

      const vesselName = getVal(["VESSEL_NAME", "Vessel_Name", "vessel_name", "VesselName"]);

      let time = "";
      if (type === "arrival") {
        time = getVal(["ARRIVAL_TIME", "Arrival_Time", "arrival_time", "ArrivalTime"]);
      } else {
        time = getVal(["ATD_TIME", "Atd_Time", "atd_time", "AtdTime", "DEPARTURE_TIME", "Departure_Time", "departure_time", "Dep_Time", "DEP_TIME"]);
      }

      let location = "";
      if (type === "arrival") {
        location = getVal(["CURRENT_LOCATION", "Current_Location", "current_location", "ANCHORAGE", "Anchorage"]);
      } else {
        location = getVal(["LAST_BERTH", "Last_Berth", "last_berth", "LastBerth", "BERTH", "Berth", "DEPARTURE_BERTH", "Departure_Berth"]);
      }

      return {
        vesselName: vesselName,
        type: type === "arrival" ? "抵港" : "離港",
        time: time,
        location: location,
        shipType: getVal(["SHIP_TYPE", "Ship_Type", "ship_type", "ShipType"]),
        callSign: getVal(["CALL_SIGN", "Call_Sign", "call_sign", "CallSign"]),
        agentName: getVal(["AGENT_NAME", "Agent_Name", "agent_name", "AgentName"]),
        remark: getVal(["REMARK", "Remark", "remark"])
      };
    }

    function displayResults(data, searchTerm) {
      hideLoading();
      const normalized = Array.isArray(data) ? data : [];
      const deduped = dedupeRecords(normalized);
      const sorted = sortByTimeAscending(deduped);
      currentData = sorted;

      if (sorted.length === 0) {
        showNoResults();
        return;
      }

      hideNoResults();
      showSuccess(`找到 ${sorted.length} 筆記錄`);
      displayStats(sorted);
      createTable(sorted, searchTerm);
    }

    function displayStats(data) {
      const arrivals = data.filter(r => r.type === "抵港").length;
      const departures = data.filter(r => r.type === "離港").length;

      const statsHtml = `
        <div class="stat-item">
          <div class="value">${data.length}</div>
          <div class="label">總記錄數</div>
        </div>
        <div class="stat-item">
          <div class="value">${arrivals}</div>
          <div class="label">抵港</div>
        </div>
        <div class="stat-item">
          <div class="value">${departures}</div>
          <div class="label">離港</div>
        </div>
      `;

      const stats = document.getElementById("stats");
      stats.innerHTML = statsHtml;
      stats.style.display = "grid";
    }

    function createTable(data, searchTerm) {
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");
      const tableWrapper = document.getElementById("tableWrapper");

      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      const columns = [
        { key: "vesselName", label: "船隻名稱" },
        { key: "type", label: "類型" },
        { key: "time", label: "時間" },
        { key: "location", label: "位置" },
        { key: "shipType", label: "船舶類型" },
        { key: "callSign", label: "呼號" },
        { key: "agentName", label: "代理" }
      ];

      const headerRow = document.createElement("tr");
      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col.label;
        headerRow.appendChild(th);
      });
      tableHead.appendChild(headerRow);

      data.forEach(record => {
        const row = document.createElement("tr");

        columns.forEach(col => {
          const td = document.createElement("td");
          const value = record[col.key] || "-";

          if (col.key === "type") {
            const badge = document.createElement("span");
            badge.className = `badge ${value === "抵港" ? "badge-arrival" : "badge-departure"}`;
            badge.textContent = value;
            td.appendChild(badge);
          } else {
            td.textContent = value;
            if (searchTerm && String(value).toUpperCase().includes(searchTerm.toUpperCase())) td.classList.add("highlight");
          }
          row.appendChild(td);
        });

        tableBody.appendChild(row);
      });

      tableWrapper.classList.add("show");
    }

    function clearSearch() {
      document.getElementById("vesselName").value = "";
      document.getElementById("dataType").value = "both";
      document.getElementById("useLast36h").checked = true;

      const today = new Date().toISOString().split("T")[0];
      const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split("T")[0];
      document.getElementById("startDate").value = yesterday;
      document.getElementById("endDate").value = today;

      syncDateEnabledState();
      clearResults();
    }
  </script>
</body>
</html>
